<?php

/**
 * RsgoProcesos
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    symfony
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 6820 2009-11-30 17:27:49Z jwage $
 */
class RsgoProcesos extends BaseRsgoProcesos
{
    const FOLDER = "Procesos";
    /*
     * Retorna el objeto riesgos ordenado por fecha de creación
     * @author: Andrea Ramírez
     */

    public function getIdgRiesgos() {
        
        return Doctrine::getTable("RsgoRiesgos")
                ->createQuery("r")
                ->select("r.*")                
                ->where("r.ca_idproceso = ? ", $this->getCaIdproceso())
                ->orderBy("r.ca_fchcreado ASC")
                ->execute();
    }
    
    public function getUltimaVersion(){
        
        $q = Doctrine::getTable("RsgoVersion")
                ->createQuery("v")
                ->where("v.ca_idproceso = ? ", $this->getCaIdproceso())
                ->orderBy("v.ca_version DESC")
                ->fetchOne();
        
        if($q)
            return $q->getCaVersion()+1;
        else
            return 1;
    }
    
    public function getDirectorio() {
        $folder = IdgProcesos::FOLDER;
        return $directory = sfConfig::get('app_digitalFile_root') . DIRECTORY_SEPARATOR . $this->getDirectorioBase();
    }

    public function getDirectorioBase() {
        $folder = IdgProcesos::FOLDER;
        return $directory = $folder . DIRECTORY_SEPARATOR . $this->getCaIdproceso();
    }
    
    public function getCaNombreProceso() {
        
        return $this->getCaPrefijo()." ".$this->getCaNombre();
    }
    
    public function getEmpresaGrupo() {        
        return $this->getCaIdempresa()?utf8_encode($this->getEmpresa()->getCaNombre()):"Transversales";
    }
    
    public function asignarPermisos($usuarios, $perfil){
        
        $usu_admins = Doctrine::getTable("UsuarioPerfil")->findBy("ca_perfil", self::PERFIL_ADMON);                        
            
        foreach($usu_admins as $usuario){
            $permiso = Doctrine::getTable("RsgoPermisos")->findByDql("ca_idproceso = ? AND ca_login = ?", array($proceso->getCaIdproceso(),$usuario->getCaLogin()))->getFirst();

            if(!$permiso){
                $permiso = new RsgoPermisos();
                $permiso->setCaIdproceso($proceso->getCaIdproceso());
                $permiso->setCaLogin($usuario->getCaLogin());
            }

            $permiso->setCaRiesgosView(true);
            $permiso->setCaRiesgosNew(true);
            $permiso->setCaRiesgosEdit(true);
            $permiso->setCaRiesgosDelete(true);
            $permiso->setCaRiesgosApproval(true);
            $permiso->setCaValoracionView(true);
            $permiso->setCaValoracionNew(true);
            $permiso->setCaValoracionEdit(true);
            $permiso->setCaValoracionDelete(true);
            $permiso->setCaEventosView(true);
            $permiso->setCaEventosNew(true);
            $permiso->setCaEventosEdit(true);
            $permiso->setCaEventosDelete(true);
            $permiso->setCaInformesView(true);
            $permiso->setCaInformesNew(true);
            $permiso->save($conn);
        }
        
    }
}
