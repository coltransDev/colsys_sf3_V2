<?php

/**
 * Riesgos
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    symfony
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 6820 2009-11-30 17:27:49Z jwage $
 */
class Riesgos extends BaseRiesgos
{
    /*
     * Retorna el objeto Causas ordenado por fecha de creación
     * @author: Andrea Ramírez
     */

    public function getRsgoCausas() {
        
        return Doctrine::getTable("RsgoCausas")
                ->createQuery("c")
                ->select("c.*")                
                ->where("c.ca_idriesgo = ? ", $this->getCaIdriesgo())
                ->orderBy("c.ca_orden ASC")
                ->execute();
    }
    
    /*
     * Retorna la última valoración de cada riesgo
     * @author: Andrea Ramírez
     */

    public function getUltimaValoracion() {
        
        return Doctrine::getTable("RsgoValoracion")
                ->createQuery("r")
                ->select("r.*")                
                ->where("r.ca_idriesgo = ? ", $this->getCaIdriesgo())
                ->orderBy("r.ca_ano DESC")
                ->fetchOne();
    }    
    
    public function getClasificacion() {
        
        if($this->getCaClasificacion()){
            $clasificacion = explode(",",str_replace(array("{","}"), "", $this->getCaClasificacion()));            
            //echo "<pre>";print_r($clasificacion);echo "</pre>";
            
            $textoClasificacion = "";
            $i=0;
            //$textoClasificacion = "<dl><dt><b>Clasificaci&oacuten del Riesgo:</b></dt>";
            foreach($clasificacion as $key => $idclasif){
                
                if($idclasif !== '0'){                    
                    $tipo = ParametroTable::retrieveByCaso( "CU286", null , null, $idclasif);                
                    $textoClasificacion.= $tipo[0]->getCaValor()."<br/>";
                    $i++;
                }
            }
            
            if($i === 0){
                return "Sin clasificar<br/>";
            }
            //exit;            
            //$textoClasificacion.= "</dl>";
            return $textoClasificacion;
        }
        return null;
    }    
}
