<?php

/**
 * IdsRestrictivas
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    symfony
 * @subpackage model
 * @author     Carlos Gilberto López M.
 * @version    SVN: $Id: Builder.php 6820 2009-11-30 17:27:49Z jwage $
 */
class IdsRestrictivas extends BaseIdsRestrictivas {

    public function getConsultaListas($tipoConsulta, $parametro) {
        $server = sfConfig::get("app_sinteParams_server");
        $username = sfConfig::get("app_sinteParams_username");
        $password = sfConfig::get("app_sinteParams_password");
        $percent = sfConfig::get("app_sinteParams_percent");

        ProjectConfiguration::registerZend();

        $client = new Zend_Http_Client();

        $uri = $server . "/WS_COLTRANS/webresources/listas/consultar";
        $client->setUri($uri);

        $client->setAuth($username, $password, Zend_Http_Client::AUTH_BASIC);

        $client->setParameterGet('tipo_consulta', $tipoConsulta);
        if ($tipoConsulta == "DOCUMENTO") {
            $client->setParameterGet('parametro', $parametro);
        } else {
            $client->setParameterGet('parametro', $parametro);
            $client->setParameterGet('pcoincidencia', $percent);
        }
        $result = $client->request(Zend_Http_Client::GET);
        $json_response = json_decode($result->getBody());

        if ($json_response) {
            $id_response = $json_response->id;
            $res_response = ($json_response->respuesta) ? $json_response->respuesta : null;
            $fch_response = $json_response->fecha;
        } else {
            $id_response = ($result->getMessage()) ? $result->getMessage() : null;
            $res_response = -1; // Indicador de Error
            $fch_response = date("Y-m-d h:i:s");
        }

        $consulta = new IdsRestrictivas();
        $consulta->setCaId($this->getCaId());
        $consulta->setCaTipoConsulta($tipoConsulta);
        $consulta->setCaParametro($parametro);
        $consulta->setCaIdrespuesta($id_response);
        $consulta->setCaRespuesta($res_response);
        $consulta->setCaFchconsultado($fch_response);
        $consulta->save();
        $consulta->enviarRespuesta();
        return $consulta;
    }

    public function enviarRespuesta($identificacion = null, $nombre_completo = null) {
        $identificacion = $identificacion ? $identificacion : $this->getIds()->getCaIdalterno();
        $nombre_completo = $nombre_completo ? $nombre_completo : $this->getIds()->getCaNombre();
        
        if ($this->getCaRespuesta()) {
            $contentHTML = "<br /><br />
            ***** ALERTA *****
            <br />
            La consulta en Listas Restrictivas generó el siguiente resultado:<br />
            <table>
                    <tr>
                        <td><strong>Nit:</strong></td><td>" . $identificacion . "</td>
                    </tr>
                    <tr>
                        <td><strong>Nombre:</strong></td><td>" . $nombre_completo . "</td>
                    </tr>
                    <tr>
                        <td colspan=\"2\">$nbsp</td>
                    </tr>
                    <tr>
                        <td><strong>Tipo Consulta:</strong></td><td>" . $this->getCaTipoConsulta() . "</td>
                    </tr>
                    <tr>
                        <td><strong>Resultado:</strong></td><td>" . $this->getCaRespuesta() . "</td>
                    </tr>
                    <tr>
                        <td><strong>Fecha:</strong></td><td>" . $this->getCaFchconsultado() . "</td>
                    </tr>
            </table>
            <br />
            Agradecemos tomar las acciones correspondientes e informar a los interesados.";

            $parametro = Doctrine::getTable("Parametro")->find(array("CU267", 1, "defaultEmails"));
            if (stripos($parametro->getCaValor2(), ',') !== false) {
                $defaultEmail = explode(",", $parametro->getCaValor2());
            } else {
                $defaultEmail = array($parametro->getCaValor2());
            }
            $parametro = Doctrine::getTable("Parametro")->find(array("CU267", 2, "ccEmails"));
            if (stripos($parametro->getCaValor2(), ',') !== false) {
                $ccEmails = explode(",", $parametro->getCaValor2());
            } else {
                $ccEmails = array($parametro->getCaValor2());
            }

            $email = new Email();
            $email->setCaUsuenvio("Administrador");
            $email->setCaTipo("ConsultaSinte");
            $email->setCaFrom("no-reply@coltrans.com.co");
            $email->setCaFromname("Colsys Notificaciones");
            reset($defaultEmail);
            while (list ($clave, $val) = each($defaultEmail)) {
                $email->addTo($val);
            }
            reset($ccEmails);
            while (list ($clave, $val) = each($ccEmails)) {
                $email->addCc($val);
            }
            $email->setCaSubject("ALERTA! Resultado en Listas Restrictivas " . $nombre_completo . " Id: " . $this->getIds()->getCaIdalterno());
            $email->setCaBodyhtml($contentHTML);
            $email->setCaBody($contentPlain);
            $email->save();
        }
    }

}
