<?php

/**
 * Ids
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    ##PACKAGE##
 * @subpackage ##SUBPACKAGE##
 * @author     ##NAME## <##EMAIL##>
 * @version    SVN: $Id: Builder.php 5845 2009-06-09 07:36:57Z jwage $
 */
class Ids extends BaseIds
{
    const FOLDER = "ids";

    private $idsProveedor = null;

    public function __toString(){
        return $this->getcaNombre();
    }
    /*
    *
    */
    public function getSucursalPrincipal( ){        
        return Doctrine::getTable("IdsSucursal")
                         ->createQuery("s")
                         ->where("s.ca_principal = ?", true)
                         ->addWhere("s.ca_id = ? ", $this->getCaId())
                         ->fetchOne();
    }

    /*
    *
    */
    public function getDocumento( $idtipo ){
        
        return Doctrine::getTable("IdsDocumento")
                ->createQuery("d")
                ->select("d.*")
                ->where("d.ca_idtipo = ?",$idtipo )
                ->addWhere("d.ca_id = ?",$this->getCaId() )
                ->addOrderBy("d.ca_iddocumento DESC")
                ->fetchOne();
    }


    public function getCalificaciones( ){       
        

        $result = array();
        $rows  = Doctrine::getTable("IdsEvaluacion")
                ->createQuery("ev")
                ->innerJoin("ev.IdsEvaluacionxCriterio e")
                ->select("ev.ca_ano,SUM(e.ca_valor*e.ca_ponderacion )/SUM(e.ca_ponderacion ) as calificacion")
                ->addWhere("ev.ca_id = ?",$this->getCaId() )
                ->addWhere("ev.ca_tipo like ?",'desempeno%' )
                ->addGroupBy("ev.ca_ano")
                ->addOrderBy("ev.ca_ano")
                ->setHydrationMode(Doctrine::HYDRATE_SCALAR)
                ->execute();
        foreach( $rows as $row ){           
            $result[$row["ev_ca_ano"]]=round($row["e_calificacion"], 1);
        }
        return $result;

        
    }


    public function getIdsProveedor(){
        if( !$this->idsProveedor ){
            $this->idsProveedor = Doctrine::getTable("IdsProveedor")->find($this->getCaId());
        }

        return $this->idsProveedor;

    }
}