<?php

/**
 * FileImported
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    symfony
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 6820 2009-11-30 17:27:49Z jwage $
 */
class FileImported extends BaseFileImported
{
    private $row = array();


	public function process( $conn=null ){
		$header = $this->getFileHeader();
		
		$registros = Doctrine::getTable("FileColumn")
                               ->createQuery("f")
                               ->innerJoin("f.Registro")
                               ->where("f.ca_idfileheader = ? ", $header->getCaIdfileheader())
                               ->execute();

		$resultado = array();

		$content = explode("\n",$this->getCaContent());

                $num_iddocs = "";
               
		foreach ($content as $line )
		{
                        
                        foreach( $registros as $registro ){
				$this->row = array();

				if( $registro->getCaColumna() == substr( $line, 0, strlen($registro->getCaColumna()) ) ){
					$columnas=$registro->getColumnasRegistros();
					//Empieza el proceso del registro
					$pos = 0;

					foreach( $columnas as $columna ){
						if( $columna->getCaTipo()=="date" ){
							$value = Utils::parseDate( (substr( $line, $pos, $columna->getCaLongitud() )));
						}else{
							$value = substr( $line, $pos, $columna->getCaLongitud() );
						}
						$this->row[$columna->getCaColumna()]=$value;
						$pos +=$columna->getCaLongitud() ;

					}

                                        if(!$this->processFalabella($num_iddocs, $conn)){
						return false;
					}
				}
			}
		}
		return true;
	}

	public function processFalabella(&$num_iddocs, $conn=null){
                $table = '';
                if ($this->getCaProceso() == 'Coltrans'){
                    $table = 'FalaHeader';
                }elseif ($this->getCaProceso() == 'Colmas'){
                    $table = 'FalaHeaderAdu';
                }

		if(isset($this->row['FALPOH01'])){ //REGISTRO TIPO 1
                        $header = Doctrine::getTable($table)
                                       ->createQuery("h")
                                       ->where("h.ca_iddoc LIKE ? ", trim($this->row['po_number'])."%")
                                       ->execute();
                        if ($header->count()!=0){   // Analiza cuantos registros con el mismo número de orden hay y les agrega un -consecutivo
                            $num_iddocs = "-".$header->count();
                        }

                        $header = Doctrine::getTable($table)->find(trim($this->row['po_number']).$num_iddocs);

			if( !$header ){ //Verifica que no se haya procesado
                                if ($this->getCaProceso() == 'Coltrans'){
                                    $falaHeader = new FalaHeader();
                                }else if ($this->getCaProceso() == 'Colmas'){
                                    $falaHeader = new FalaHeaderAdu();
                                }

				$falaHeader->setCaIddoc( trim($this->row['po_number']).$num_iddocs );
				$falaHeader->setCaFechaCarpeta( $this->row['po_date'] );
				$falaHeader->setCaCodigoPuertoPickup( $this->row['origin'] );
				$falaHeader->setCaCodigoPuertoDescarga( $this->row['destination'] );
				$falaHeader->setCaCodigoProveedor( $this->row['vendor_id'] );
				$falaHeader->setCaNombreProveedor( $this->row['vendor_name'] );
				$falaHeader->setCaArchivoOrigen( $this->getCaNombre() );
				$falaHeader->setCaTrader( trim($this->row['trader']) );
				$falaHeader->setCaVendorId( trim($this->row['vendor_id']) );
				$falaHeader->setCaVendorName( trim($this->row['vendor_name']) );
				$falaHeader->setCaVendorAddr1( trim($this->row['vendor_addr1']) );
				$falaHeader->setCaVendorCity( trim($this->row['vendor_city']) );
				$falaHeader->setCaVendorCountry( trim($this->row['vendor_country']) );
				$falaHeader->setCaEsd( trim($this->row['esd']) );
				$falaHeader->setCaLsd( trim($this->row['lsd']) );
				$falaHeader->setCaIncoterms( trim($this->row['incoterm']) );
				$falaHeader->setCaPaymentTerms( trim($this->row['payment_terms']) );
				$falaHeader->setCaProformaNumber( trim($this->row['proforma_number']) );
				$falaHeader->setCaOrigin( trim($this->row['origin']) );
				$falaHeader->setCaDestination( trim($this->row['destination']) );
				$falaHeader->setCaTransShipPort( trim($this->row['trans_ship_port']) );
				// $falaHeader->setCaReqdDelivery( trim($this->row['reqd_delivery']) );
				$falaHeader->setCaOrdenComments( trim($this->row['orden_comments']) );
				$falaHeader->setCaManufacturerContact( trim($this->row['manufacturer_contact']) );
				$falaHeader->setCaManufacturerPhone( trim($this->row['manufacturer_phone']) );
				$falaHeader->setCaManufacturerFax( trim($this->row['manufacturer_fax']) );
				$falaHeader->save( $conn );
			}else{
				return false;
			}

		}

		if(isset($this->row['FALPOH02'])){
			if( Doctrine::getTable($table)->find(trim($this->row['po_number']).$num_iddocs) ){
                                
                                if ($this->getCaProceso() == 'Coltrans'){
                                    $falaShip = new FalaShipmentInfo();
                                }else if ($this->getCaProceso() == 'Colmas'){
                                    $falaShip = new FalaShipmentInfoAdu();
                                }

				$falaShip->setCaIddoc( trim($this->row['po_number']).$num_iddocs );
				$falaShip->setCaBeginWindow( trim($this->row['esd']) );
				$falaShip->setCaEndWindow( trim($this->row['lsd']) );
				$falaShip->setCaCommodities( trim($this->row['commodities']) );
				$falaShip->setCaPartial( trim($this->row['partial']) );
				$falaShip->setCaPaymentTerms( trim($this->row['payment_terms']) );
				$falaShip->setCaIncoterms( trim($this->row['incoterm']) );
				$falaShip->setCaContainerType( trim($this->row['container_type']) );
				$falaShip->setCaUtv( trim($this->row['utv']) );
				$falaShip->setCaEtv( trim($this->row['etv']) );
				$falaShip->setCaLine( trim($this->row['line']) );
				$falaShip->setCaContactLine( trim($this->row['contact_line']) );
				$falaShip->setCaContactImporter( trim($this->row['contact_Importer']) );
				$falaShip->setCaUppo( trim($this->row['uppo']) );
				$falaShip->setCaEb( trim($this->row['eb']) );
				$falaShip->setCaEdd( trim($this->row['edd']) );
				$falaShip->setCaPort( trim($this->row['port']) );
				$falaShip->setCaTransshipment( trim($this->row['transshipment']) );
				$falaShip->setCaTransshipmentPort( trim($this->row['transshipment_port']) );
				$falaShip->setCaShippingOrg( trim($this->row['shipping_org']) );
				$falaShip->setCaOriginalOrg( trim($this->row['original_org']) );
				$falaShip->setCaFwdCopyOrg( trim($this->row['fwd_copy_org']) );
				$falaShip->setCaFcrOrg( trim($this->row['fcr_org']) );
				$falaShip->setCaShippingDst( trim($this->row['shipping_dst']) );
				$falaShip->setCaOriginalDst( trim($this->row['original_dst']) );
				$falaShip->setCaFwdCopyDst( trim($this->row['fwd_copy_dst']) );
				$falaShip->setCaFcrDst( trim($this->row['fcr_dst']) );
				$falaShip->setCaTransportVia( trim($this->row['transport_via']) );
				$falaShip->setCaInvoiceOrg( trim($this->row['invoice_org']) );
				$falaShip->setCaPackingListOrg( trim($this->row['packing_list_org']) );
				$falaShip->setCaDocumentOrg( trim($this->row['document_org']) );
				$falaShip->setCaOcOrg( trim($this->row['oc_org']) );
				$falaShip->setCaOthersDocsOrg( trim($this->row['others_docs_org']) );
				$falaShip->setCaPackingListCps( trim($this->row['packing_list_cps']) );
				$falaShip->setCaInvoiceCps( trim($this->row['invoice_cps']) );
				$falaShip->setCaDocumentCps( trim($this->row['document_cps']) );
				$falaShip->setCaOcCps( trim($this->row['oc_cps']) );
				$falaShip->setCaOthersDocsCps( trim($this->row['others_docs_cps']) );
				$falaShip->setCaFinalPort( trim($this->row['final_port']) );
				$falaShip->setCaAlterPort( trim($this->row['alter_port']) );
				$falaShip->setCaFinalPort( trim($this->row['final_port']) );
				$falaShip->setCaLimitDate( trim($this->row['limit_date']) );
				$falaShip->save( $conn );
			}
		}

		if(isset($this->row['FALPOH03'])){ //REGISTRO TIPO 3
			if( Doctrine::getTable($table)->find(trim($this->row['po_number']).$num_iddocs) ){
                                if ($this->getCaProceso() == 'Coltrans'){
                                    $falaInst = new FalaInstruction();
                                }else if ($this->getCaProceso() == 'Colmas'){
                                    $falaInst = new FalaInstructionAdu();
                                }
                                
				$falaInst->setCaIddoc( trim($this->row['po_number']).$num_iddocs );
				$falaInst->setCaInstructions( trim($this->row['instructions']) );
                                $falaInst->setCaEmbarque( trim($this->row['embarque']) );
				$falaInst->save( $conn );
			}
		}


		if(isset($this->row['FALPOD01'])){ //REGISTRO TIPO 4
			if( Doctrine::getTable($table)->find(trim($this->row['po_number']).$num_iddocs) ){
                                if ($this->getCaProceso() == 'Coltrans'){
                                    $falaDetail = new FalaDetail();
                                    $falaDetail->setCaCantidadMiles( intval($this->row['order_quantity']) );
                                }else if ($this->getCaProceso() == 'Colmas'){
                                    $falaDetail = new FalaDetailAdu();
                                    $falaDetail->setCaSku( trim($this->row['sku']) );
                                    $falaDetail->setCaCantidadDav( intval($this->row['order_quantity']) );
                                    $falaDetail->setCaCantidadDim( intval($this->row['order_quantity']) );
                                    $falaDetail->setCaValorFob( round(intval($this->row['order_quantity'])*floatval($this->row['unit_price'])/100,2) );
                                    $falaDetail->setCaPreinspeccion( 'Estilo: '.trim($this->row['style']).' Talla:'.trim($this->row['talla']).'Color: '.trim($this->row['color']).' Composicion:'.trim($this->row['composicion']) );
                                    $falaDetail->setCaSubpartida( '' );
                                }
				$falaDetail->setCaIddoc( trim($this->row['po_number']).$num_iddocs );
				$falaDetail->setCaSku( trim($this->row['sku']) );
				$falaDetail->setCaDescripcionItem( trim($this->row['item_description']) );
                                $falaDetail->setCaCantidadPedido( intval($this->row['order_quantity']) );
				$falaDetail->setCaUnidadMedidadCantidad( "PC" );
				$falaDetail->setCaCantidadPaquetesMiles( floatval($this->row['ctns']) );
				$falaDetail->setCaUnidadMedidaPaquetes( "CT" );
				$falaDetail->setCaCantidadVolumenMiles( floatval(($this->row['ctn_hgt'] * $this->row['ctn_wid'] * $this->row['ctn_lgt'])) );
				$falaDetail->setCaUnidadMedidaVolumen( substr($this->row['long'],0,2) );
				$falaDetail->setCaCantidadPesoMiles( floatval($this->row['kgs_net']) );
				$falaDetail->setCaUnidadMedidaPeso( $this->row['unit_measure'] );
				$falaDetail->save( $conn );
			}
		}
		return true;

	}
}
