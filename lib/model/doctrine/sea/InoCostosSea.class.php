<?php

/**
 * InoCostosSea
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    symfony
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 6820 2009-11-30 17:27:49Z jwage $
 */
class InoCostosSea extends BaseInoCostosSea
{
    static public function setCosto($comprobante,$conn ) {
        try {
            $idproveedor="2533";//colotm
            $idcostos=array(4,15,47,246);
            $inoCliente = Doctrine::getTable("InoClientesSea")->findOneBy("ca_hbls", $comprobante->getInoHouse()->getCaDoctransporte());
            if(!$inoCliente)
                return "-1";
            $inoMaestraSea=$inoCliente->getInoMaestraSea();

            if($inoMaestraSea->getCaFchcerrado()!="")
                return "-2";

            $costos = Doctrine::getTable("InoCostosSea")
                               ->createQuery("c")
                               ->addWhere("c.ca_referencia = ? and ca_idproveedor = ? and ca_factura = ?", array($inoMaestraSea->getCaReferencia() , $idproveedor , $comprobante->getCaConsecutivo()) )
                               ->execute();

            if(count($costos)>0)
                return "-3";
            
            
            $costos = Doctrine::getTable("InoCostosSea")
                   ->createQuery("c")
                   ->addWhere("c.ca_referencia = ? and ca_factura = ?", array($inoMaestraSea->getCaReferencia() , $comprobante->getCaConsecutivo()) )
                   ->andWhereIn("ca_idcosto", $idcostos)
                   ->execute();

            if(count($costos)>0)
                return "-3";
            
            
            $iddeducciones=array(109,110,111,112,113);
            $deduccion=new InoDeduccionesSea();
            
            $deduccion = Doctrine::getTable("InoDeduccionesSea")
                               ->createQuery("c")
                               ->addWhere("c.ca_referencia = ? and ca_idcliente = ? and ca_hbls = ? ", array($inoMaestraSea->getCaReferencia() , $inoCliente->getCaIdcliente() , $comprobante->getInoHouse()->getCaDoctransporte() ) )
                               ->andWhereIn("ca_iddeduccion",$iddeducciones)
                               ->fetchOne();
            

            if(count($deduccion)<1 || !$deduccion)
            {
                $valor2=$comprobante->getCaValor();
            }
            else
            {
                $valor2=$deduccion->getCaValor();
                $deduccion->delete($conn);
            }
            
            $inoCostosSea = new InoCostosSea();            
            $costo = Doctrine::getTable("Costo")
                               ->createQuery("c")
                               ->addWhere("c.ca_modalidad = ? and ca_costo = ? ", array($inoMaestraSea->getCaModalidad() , "OTM" ) )
                               ->fetchOne();

            $inoCostosSea->setCaFactura($comprobante->getCaConsecutivo());
            $inoCostosSea->setCaFchfactura($comprobante->getCaFchcomprobante());

            $inoCostosSea->setCaIdcosto($costo->getCaIdcosto());
            $inoCostosSea->setCaIdmoneda($comprobante->getCaIdmoneda());
            $inoCostosSea->setCaIdproveedor($idproveedor);
            $inoCostosSea->setCaProveedor("COLOTM-".$comprobante->getInoHouse()->getCliente()->getCaCompania()."-".$comprobante->getInoHouse()->getCaDoctransporte());
            $inoCostosSea->setCaNeto($comprobante->getCaValor());
            $inoCostosSea->setCaReferencia($inoMaestraSea->getCaReferencia());
            $inoCostosSea->setCaTcambio($comprobante->getCaTcambio());
            $inoCostosSea->setCaTcambioUsd($comprobante->getCaTcambioUsd());
            $inoCostosSea->setCaVenta($valor2);
            $inoCostosSea->save($conn);
            
            $idinocosto=$inoCostosSea->getCaIdinocostosSea();
            
            if($valor2>$comprobante->getCaValor())
            {
                $inoutilidadSea = new InoutilidadSea();
                $inoutilidadSea->setCaIdinocosto($idinocosto);
                $inoutilidadSea->setCaValor($valor2-$comprobante->getCaValor());
                $inoutilidadSea->save($conn);
            }
            return $inoCostosSea->getOid();            
        }
        catch(Exception $e)
        {
            throw new Exception("Error : ".$e->getMessage());
        }
    }
    
}
