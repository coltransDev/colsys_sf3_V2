<?php

/**
 * CotSeguimiento
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    ##PACKAGE##
 * @subpackage ##SUBPACKAGE##
 * @author     ##NAME## <##EMAIL##>
 * @version    SVN: $Id: Builder.php 5845 2009-06-09 07:36:57Z jwage $
 */
class CotSeguimiento extends BaseCotSeguimiento
{
    public function getEtapa(){
        $parametro = ParametroTable::retrieveByCaso("CU074", $this->getCaEtapa() );

		if( $parametro ){
			return $parametro[0]->getCaValor2();
		}
    }


    public function aprobarSeguimiento( $param ){        

        $idproducto=(isset($param["idproducto"])?$param["idproducto"]:"");
        $etapa=$param["etapa"];
        $user=$param["user"];
        $seguimientos=(isset($param["seguimiento"])?$param["seguimiento"]:"");
        $fchseguimiento=(isset($param["fchseguimiento"])?$param["fchseguimiento"]:"");
        $coti=(isset($param["cotizacion"])?$param["cotizacion"]:"");
        $idcoti=(isset($param["idcotizacion"])?$param["idcotizacion"]:"");

        if( $idproducto !="" ){
            $producto = Doctrine::gettable("CotProducto")->find( $idproducto );
            if(!$producto)
                return 0;

            if( $producto->getCaIdtarea()  ){
                $tarea  =  Doctrine::gettable("NotTarea")->find( $producto->getCaIdtarea() );
                if($tarea->getCaFchterminada()=="")
                {
                    $tarea->setCaFchterminada( date("Y-m-d H:i:s") );
                    $tarea->save();
                }
            }
            $cotizacion = Doctrine::gettable("Cotizacion")->find( $producto->getCaIdcotizacion() );
        }
        else if($coti!="")
        {
            $cotizacion = Doctrine::gettable("Cotizacion")->findOneBy("ca_consecutivo", $coti);
        }
        else if($idcoti!="")
        {
            $cotizacion = Doctrine::gettable("Cotizacion")->find($idcoti);
        }
        
        if(!$cotizacion)
            return 0;


        $seguimiento = new CotSeguimiento();
        if( $idproducto !=""){
            $seguimiento->setCaIdproducto( $idproducto );
            $producto->setCaEtapa( $etapa );
            $producto->save();
        }
        else if($cotizacion)
        {
            $seguimiento->setCaIdcotizacion( $cotizacion->getCaIdcotizacion() );
            $cotizacion->setCaEtapa($etapa);
            $cotizacion->save();
        }


        $seguimiento->setCaLogin( $user );
        $seguimiento->setCaFchseguimiento( date("Y-m-d H:i:s") );
        $seguimiento->setCaSeguimiento( $seguimientos );
        $seguimiento->setCaEtapa( $etapa );
        $seguimiento->save();

        if( $fchseguimiento )
        {
            $titulo = "Seguimiento Cotización ".$cotizacion->getCaConsecutivo()." ".$cotizacion->getCliente()->getCaCompania()."";
            $texto = "Ha programado un seguimiento para una cotización, por favor haga click en el link para realizar esta tarea";
            $tarea = new NotTarea();
            $tarea->setCaUrl( "/cotseguimientos/verSeguimiento/idcotizacion/".$cotizacion->getCaIdcotizacion() );
            $tarea->setCaIdlistatarea( 7 );

            $tarea->setCaFchvencimiento( $fchseguimiento." 23:59:59" );
            $tarea->setCaFchvisible( $fchseguimiento." 00:00:00" );
            $tarea->setCaUsucreado( $user );
            $tarea->setCaTitulo( $titulo );
            $tarea->setCaTexto( $texto );
            $tarea->save();
            $loginsAsignaciones = array( $user, $cotizacion->getCaUsuario() );
            $loginsAsignaciones = array_unique( $loginsAsignaciones );
            $tarea->setAsignaciones( $loginsAsignaciones );

            if( $idproducto ){
                $producto->setCaIdtarea( $tarea->getCaIdtarea() );
                $producto->save();
            }
        }
	}
}
