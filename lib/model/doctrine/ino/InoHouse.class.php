<?php

/**
 * InoHouse
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    symfony
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 6820 2009-11-30 17:27:49Z jwage $
 */
class InoHouse extends BaseInoHouse
{
    private $master=null;
    private $comprobantes=null;
    private $facturas=null;
    private $rc=null;
    private $comisiones=null;
    
    function calculateFee()
    {
        if($this->master==null)
            $this->master=$this->getInoMaster();
        
        $sql="SELECT fun_getcomision('".$this->getCaIdcliente()."', '".$this->master->getCaReferencia()."', 'Colmas'::text) AS ca_porcentaje";
        $con = Doctrine_Manager::getInstance()->connection();        
        $st = $con->execute($sql);
        $porcentaje = $st->fetchColumn();
        //print_r( $porcentaje);
        //exit;
        
        $costo=$this->master->getInoViCosto()->getCaValor();
        $ingreso=$this->master->getInoViIngreso()->getCaValor();
        $deduccion=$this->master->getInoViDeduccion()->getCaValor();
        $utilidad=$this->master->getInoViUtilidad()->getCaValor();
        $ino=$ingreso+$utilidad-$costo-$deduccion;
        //echo "ino:$ino - porce:$porcentaje<br>";
        $comision=($ino * ($porcentaje/100)  );
        //echo $this->getCaIdcliente()."-".$this->master->getCaReferencia()."-".$comision;
        //$r["comision_ino"]=($r["ino"]*($r["ca_porcentaje"]/100))-$r["comision_cobrada"];
        $sql="SELECT sum(det.ca_cr) as com
                FROM ino.tb_comprobantes com,ino.tb_detalles det 
                WHERE com.ca_idcomprobante=det.ca_idcomprobante and det.ca_idmaster=".$this->getCaIdmaster()." AND 
                det.ca_idhouse=".$this->getCaIdhouse()." AND com.ca_idtipo IN(11) and det.ca_cr !=0 and ca_fchanulado is  null and ca_usuanulado is  null limit 1";
        $con = Doctrine_Manager::getInstance()->connection();
        $st = $con->execute($sql);
        $refs = $st->fetchAll();
        $comision_cobrada=0;
        foreach($refs as $r)
        {
            $comision_cobrada+=$r["com"];
        }        
        return $comision-$comision_cobrada;
    }
    
    function getCosto()
    {
        if($this->master==null)
            $this->master=$this->getInoMaster();
        return $this->master->getInoViCosto()->getCaValor();
    }
    function getIngreso()
    {
        if($this->master==null)
            $this->master=$this->getInoMaster();
        return $this->master->getInoViIngreso()->getCaValor();
    }
    function getUtilidad()
    {
        if($this->master==null)
            $this->master=$this->getInoMaster();
        return $this->master->getInoViUtilidad()->getCaValor();
    }
    function getDeduccion()
    {
        if($this->master==null)
            $this->master=$this->getInoMaster();
        return $this->master->getInoViDeduccion()->getCaValor();
    }
    
    function getIno()
    {
        return $this->getIngreso()  + $this->getUtilidad() - $this->getCosto() - $this->getDeduccion();       
    }
    
    function getComprobantes()
    {        
        $this->comprobantes=$this->getInoComprobante();
        foreach($this->comprobantes as $c)
        {
            switch($c->getCaIdtipo())
            {
                case "11":
                    $this->comisiones[]=$c;
                    break;
                case "12":
                    $this->rc[]=$c;
                    break;
                default :
                    $this->facturas[]=$c;
                    
            }
        }
    }
    
    function getFacturas()
    {
        if($this->comprobantes==null)
            $this->getComprobantes ();
        return $this->facturas;
    }
    
    function getReciboCaja()
    {
        if($this->comprobantes==null)
            $this->getComprobantes ();
        return $this->rc;
    }
    
    function getComisiones()
    {
        if($this->comprobantes==null)
            $this->getComprobantes ();
        return $this->comisiones;
    }
    
}
