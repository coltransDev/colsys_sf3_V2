<?php

/**
 * InoSeguro
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    symfony
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 6820 2009-11-30 17:27:49Z jwage $
 */
class InoSeguro extends BaseInoSeguro {

    public function getCaReferencia() {
        if ($this->getCaIdhouse()) {
            return $this->getInoHouse()->getInoMaster()->getCaReferencia();
        } else if ($this->getCaIdequipo()) {
            return $this->getInoEquipo()->getInoMaster()->getCaReferencia();
        } else if ($this->getCaRefaduana()) {
            return $this->getInoMaestraAdu()->getCaReferencia();
        }
        return null;
    }

    public function getCaObservacionesFull() {
        $observaciones = "";
        if ($this->getCaUsuanulado()) {
            $observaciones = "Anulado " . $this->getCaUsuanulado() . " - " . $this->getCaFchanulado();
        } else if ($this->getCaFchliquidado()) {
            $observaciones = "Liquidado " . $this->getCaUsuliquidado() . " - " . $this->getCaFchliquidado();
        } else {
            $datos = json_decode(utf8_encode($this->getCaDatos()));
            $campo = "pre-liquidado";
            if ($datos->$campo) {
                $observaciones = "Pre-Liquidado ";
            }
        }
        return $observaciones . $this->getCaObservaciones();
    }

    public function getUnidadNegocio() {
        if ($this->getCaIdhouse()) {
            if (substr($this->getCaReferencia(), 0, 1) == "7")
                return "Carga en OTM";
            else if (substr($this->getCaReferencia(), 0, 1) == "9")
                return "Transporte Terrestre";
            else
                return "Agenciamiento Carga";
        } else if ($this->getCaIdequipo()) {
            return "Contenedores";
        } else if ($this->getCaRefaduana()) {
            $datos = json_decode(utf8_encode($this->getCaDatos()));
            return "Aduana " . $datos->aduana;
        }
        return null;
    }

    public function valoresPorDefecto() {
        $con = Doctrine_Manager::connection();
        $sql = "select ca_fecha, ca_pesos from tb_trms t order by ca_fecha desc limit 1";
        $trm = $con->fetchArray($sql);

        $datomod = ParametroTable::retrieveByCaso("CU282", null, null, null);
        $default = array();
        foreach ($datomod as $dato) {
            $default[$dato["ca_identificacion"]] = $dato["ca_valor"];
        }

        if ($this->getUnidadNegocio() == "Agenciamiento Carga" || $this->getUnidadNegocio() == "Carga en OTM") {
            $repSeguro = null;
            if ($this->getInoHouse()->getReporte()->getRepUltVersion()) {
                $repSeguro = $this->getInoHouse()->getReporte()->getRepUltVersion()->getRepSeguro();
            }

            if ($repSeguro) {
                $vlrasegurado = null;
                $this->setCaVlrasegurado($repSeguro->getCaVlrasegurado() ? $repSeguro->getCaVlrasegurado() : 0);
                $this->setCaIdmonedaVlr($repSeguro->getCaIdmonedaVlr() ? $repSeguro->getCaIdmonedaVlr() : "COP");

                $this->setCaNetoPorc($default[1]);   // % Prima por Defecto
                $valor_neto = round($repSeguro->getCaVlrasegurado() * $default[1] / 100, 0);
                $valor_neto = $valor_neto >= $default[5] ? $valor_neto : $default[5];
                $this->setCaNetoVlr($valor_neto);
                $this->setCaNetoMnd("COP");

                $this->setCaVentaPorc($repSeguro->getCaPrimaventa() ? $repSeguro->getCaPrimaventa() : 0);
                $valorPrima = round(($repSeguro->getCaVlrasegurado() ? $repSeguro->getCaVlrasegurado() : 0) * ($repSeguro->getCaPrimaventa() ? $repSeguro->getCaPrimaventa() : 0) / 100, 0);
                $ventaMinima = $repSeguro->getCaMinimaventa() * ($repSeguro->getCaIdmonedaVta() == "COP" ? 1 : $trm[1]);
                if ($valorPrima > $ventaMinima) {
                    $this->setCaVentaVlr($valorPrima);
                } else {
                    $this->setCaVentaVlr($ventaMinima);
                }
                if ($this->getCaVentaVlr() == null) {
                    $this->setCaVentaVlr(0);
                }
                $this->setCaVentaMnd("COP");
                $obtencion = explode(" ", $default[3]);
                if ($repSeguro->getCaObtencionpoliza() >= $obtencion[1]) {
                    $this->setCaObtencionVlr($repSeguro->getCaObtencionpoliza());
                    $this->setCaObtencionMnd($repSeguro->getCaIdmonedaPol() ? $repSeguro->getCaIdmonedaPol() : "COP");
                } else {
                    $this->setCaObtencionVlr($obtencion[1]);
                    $this->setCaObtencionMnd($obtencion[0]);
                }
                if ($this->getCaObtencionVlr() > 0) {
                    $this->setCaComisionVlr($default[3]);
                } else {
                    $this->setCaObtencionVlr(0);
                    $this->setCaComisionVlr(0);
                }

                $this->setCaTcambio($trm[1]);
            }
        } else if ($this->getUnidadNegocio() == "Contenedores") {
            $idConcepto = $this->getInoEquipo()->getCaIdconcepto();
            $this->setCaVlrasegurado(0);
            $this->setCaIdmonedaVlr("COP");

            $this->setCaNetoPorc(0);
            $this->setCaNetoVlr(isset($default[$idConcepto]) ? $default[$idConcepto] : 0);
            $this->setCaNetoMnd("COP");

            $this->setCaVentaPorc(0);
            $this->setCaVentaVlr(0);
            $this->setCaVentaMnd("COP");

            $this->setCaObtencionVlr(0);
            $this->setCaObtencionMnd("COP");

            $this->setCaComisionVlr($default[4]);
            $this->setCaTcambio($trm[1]);
        } else if ($this->getUnidadNegocio() == "Aduana Seguro de Carga") {
            $segAduana = Doctrine::getTable("InoCostosAdu")
                    ->createQuery("a")
                    ->addWhere("a.ca_referencia = ? ", $this->getCaRefaduana())
                    ->addWhere("a.ca_idcosto = ?", 275)
                    ->limit(1)
                    ->fetchOne();
            $this->setCaIdmonedaVlr("COP");
            $this->setCaNetoPorc($default[1] > 0 ? $default[1] : 0);   // % Prima por Defecto

            if ($segAduana) {
                $vlrAsegurado = round($segAduana->getCaNeta() / $default[1] * 100, 0);
                $vtaPorcentaje = round($vlrAsegurado / $segAduana->getCaVenta() * 100, 2);
                $vtaPorcentaje = $vtaPorcentaje <= 100 ? $vtaPorcentaje : 0;
                $this->setCaVlrasegurado($vlrAsegurado);
                $this->setCaNetoVlr($segAduana->getCaNeta());
                $this->setCaVentaVlr($segAduana->getCaVenta());
                $this->setCaVentaPorc($vtaPorcentaje);
            } else {
                $this->setCaVlrasegurado(0);
                $this->setCaNetoVlr(0);
                $this->setCaVentaVlr(0);
                $this->setCaVentaPorc(0);
            }
            $this->setCaNetoMnd("COP");
            $this->setCaVentaMnd("COP");
            $this->setCaObtencionVlr(0);
            $this->setCaObtencionMnd("COP");
            $this->setCaTcambio($trm[1]);
        }
    }

}
