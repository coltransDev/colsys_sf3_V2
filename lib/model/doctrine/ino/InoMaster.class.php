<?php

/**
 * InoMaster
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    symfony
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 6820 2009-11-30 17:27:49Z jwage $
 */
class InoMaster extends BaseInoMaster {

    private $vlrFacturado = null;
    private $vlrNotasCredito = null;
    private $vlrDeducciones = null;
    private $vlrCosto = null;
    private $vlrSobreventa = null;
    private $kilos20Pies = null;
    private $kilos40Pies = null;
    private $teusTotal = null;
    private $emails;
    private $countemails;

    public function getKilos20Pies() {
        if ($this->kilos20Pies === null) {
            $inoHouses = $this->getInoHouse();
            
            foreach ($inoHouses as $inoHouse) {
                $datos = json_decode(utf8_encode($inoHouse->getInoHouseSea()->getCaDatos()));
                if ($datos->equipos) {
                    foreach ($datos->equipos as $de) {
                        $contenedor = Doctrine::getTable("Concepto")->find($de->idconcepto);
                        if ($contenedor->getCaLiminferior() == 20) {
                            $this->kilos20Pies+= $de->kilos;
                        }
                    }
                }
            }
        }
        return $this->kilos20Pies;
    }

    public function getKilos40Pies() {
        if ($this->kilos40Pies === null) {
            $inoHouses = $this->getInoHouse();
            
            foreach ($inoHouses as $inoHouse) {
                $datos = json_decode(utf8_encode($inoHouse->getInoHouseSea()->getCaDatos()));
                if ($datos->equipos) {
                    foreach ($datos->equipos as $de) {
                        $contenedor = Doctrine::getTable("Concepto")->find($de->idconcepto);
                        if ($contenedor->getCaLiminferior() != 20) {
                            $this->kilos40Pies+= $de->kilos;
                        }
                    }
                }
            }
        }
        return $this->kilos40Pies;
    }

    public function getTeusTotal() {
        if ($this->teusTotal === null) {
            $equipos = $this->getInoEquipo();
            foreach ($equipos as $equipo) {
                if ($equipo->getConcepto()->getCaModalidad() == "FCL") {
                    $this->teusTotal += round($equipo->getConcepto()->getCaLiminferior() / 20, 0);
                }
            }
        }
        return $this->teusTotal;
    }

    public function getVlrFacturado() {
        if ($this->vlrFacturado === null) {
            $this->vlrFacturado = Doctrine::getTable("InoComprobante")
                    ->createQuery("c")
                    ->innerJoin("c.InoHouse h")
                    ->innerJoin("c.InoTipoComprobante t")
                    ->innerJoin("h.InoMaster m")
                    ->select("SUM(c.ca_valor*c.ca_tcambio)")
                    ->addWhere("m.ca_idmaster = ? ", $this->getCaIdmaster())
                    ->addWhere("t.ca_tipo =?", "F")
                    ->addWhere("c.ca_fchanulado is null")
                    //->addWhere("c.ca_estado =?", InoComprobante::TRANSFERIDO)
                    ->setHydrationMode(Doctrine::HYDRATE_SINGLE_SCALAR)
                    ->execute();
        }

        if ($this->vlrNotasCredito === null) {
            $this->vlrNotasCredito = Doctrine::getTable("InoComprobante")
                    ->createQuery("c")
                    ->innerJoin("c.InoHouse h")
                    ->innerJoin("c.InoTipoComprobante t")
                    ->innerJoin("h.InoMaster m")
                    ->select("SUM(c.ca_valor*c.ca_tcambio)")
                    ->addWhere("m.ca_idmaster = ? ", $this->getCaIdmaster())
                    ->addWhere("t.ca_tipo =?", "C")
                    ->addWhere("c.ca_fchanulado is null")
                    //->addWhere("c.ca_estado =?", InoComprobante::TRANSFERIDO)
                    ->setHydrationMode(Doctrine::HYDRATE_SINGLE_SCALAR)
                    ->execute();
        }
        return $this->vlrFacturado - $this->vlrNotasCredito;
    }

    public function getVlrDeducciones() {
        if ($this->vlrDeducciones === null) {
            $q = Doctrine::getTable("InoDeduccion")
                    ->createQuery("d")
                    ->innerJoin("d.InoComprobante c")
                    ->innerJoin("c.InoHouse h")
                    ->innerJoin("h.InoMaster m")
                    ->select("SUM(d.ca_neto*d.ca_tcambio)")
                    ->addWhere("m.ca_idmaster = ?", $this->getCaIdmaster())
                    ->addWhere("c.ca_estado = ?", 5)
                    ->setHydrationMode(Doctrine::HYDRATE_SINGLE_SCALAR);
            $this->vlrDeducciones = $q->execute();
        }
        return $this->vlrDeducciones;
    }

    public function getVlrCosto() {
        if ($this->vlrCosto === null) {
            $this->vlrCosto = Doctrine::getTable("InoCosto")
                    ->createQuery("c")
                    ->innerJoin("c.InoMaster m")
                    ->select("SUM(c.ca_neto*c.ca_tcambio/ca_tcambio_usd)")
                    ->addWhere("m.ca_idmaster = ? AND c.ca_fchanulado IS NULL", $this->getCaIdmaster())
                    ->setHydrationMode(Doctrine::HYDRATE_SINGLE_SCALAR)
                    ->execute();
        }
        return $this->vlrCosto;
    }

    public function getVlrSobreventa() {
        if ($this->vlrSobreventa === null) {
            $this->vlrSobreventa = Doctrine::getTable("InoUtilidad")
                    ->createQuery("u")
                    ->innerJoin("u.InoCosto c WITH c.ca_fchanulado IS NULL")
                    ->innerJoin("c.InoMaster m")
                    ->select("SUM(u.ca_valor)")
                    ->addWhere("m.ca_idmaster = ?", $this->getCaIdmaster())
                    ->setHydrationMode(Doctrine::HYDRATE_SINGLE_SCALAR)
                    ->execute();
        }
        return $this->vlrSobreventa;
    }

    public function getDetSobreventa() {
        $detalles = array();
        if ($this->getCaTransporte() == Constantes::MARITIMO) {
            $sql = "select CASE WHEN mc.ca_idconcepto = 164 THEN 'OTM'::text "
                    . "ELSE "
                    . "     CASE WHEN mc.ca_contenedor = true THEN 'Contenedores'::text "
                    . "         ELSE"
                    . "     'Otros'::text"
                    . "     END "
                    . "END as ca_tipo, sum(iu.ca_valor) as ca_valor "
                    . "from ino.tb_utilidad iu inner join ino.tb_costos ic on ic.ca_idinocosto = iu.ca_idinocosto AND ic.ca_fchanulado IS NULL"
                    . " inner join ino.tb_maestra_conceptos mc on mc.ca_idconcepto = ic.ca_idcosto"
                    . " where iu.ca_idhouse in "
                    . "     (select ca_idhouse from ino.tb_house where ca_idmaster = " . $this->getCaIdmaster() . ") "
                    . "GROUP BY 1;";

            $con = Doctrine_Manager::getInstance()->connection();
            $st = $con->execute($sql);
            $detalles = (array) $st->fetchAll(Doctrine_Core::FETCH_ASSOC);
        }
        return $detalles;
    }

    public function getReadOnly() {
        return $this->getCaFchliquidado() || $this->getCaFchcerrado() || $this->getCaFchanulado();
    }

    public function getCaTipo() {
        
    }

    public function getCaEmisionbl() {
        
    }

    public function getLiquidado() {
        return ($this->getCaFchliquidado()) ? TRUE : FALSE;
    }

    public function getCerrado() {
        return ($this->getCaFchcerrado()) ? TRUE : FALSE;
    }

    public function getAnulado() {
        return ($this->getCaFchanulado()) ? TRUE : FALSE;
    }

    public function getEmails() {

        $q = Doctrine::getTable("Email")
                ->createQuery("e")
                ->addWhere("ca_tipo=? and ca_idcaso = ?", array('Antecedentes', $this->getCaIdmaster()))
                ->addOrderBy("e.ca_idemail DESC");

        $this->emails = $q->execute();
        $this->countemails = count($this->emails);
        return $this->emails;
    }

    public function getCountEmails() {
        if (!$this->countemails) {
            $this->countemails = Doctrine::getTable("Email")
                    ->createQuery("e")
                    ->select("count(*) as nreg")
                    ->addWhere("ca_tipo=? and ca_idcaso= ?", array('Antecedentes', $$this->getCaIdmaster()))
                    ->setHydrationMode(Doctrine::HYDRATE_SINGLE_SCALAR)
                    ->execute();
        }
        return $this->countemails;
    }

    public function getUltEmail() {
        if (!$this->emails)
            $this->getEmails();
        if ($this->countemails > 0)
            $email = $this->emails[0];
        else
            $email = null;
        return $email;
    }
    
    public function getUltimoEventoCierre() {
        $evento = array();
        $log = Doctrine::getTable("UsuarioLog")
            ->createQuery("l")
            ->select("l.*")                        
            ->where("l.ca_url = ? ", $this->getCaIdmaster())
            ->orderBy("ca_id DESC")
            ->limit(1)
            ->fetchOne();
        if ($log) {
            $evento = array(
                "evento" => $log->getCaEvent(),
                "usuario" => $log->getCaLogin(),
                "fecha" => $log->getCaFchevento()
            );
        }
        return $evento;
    }

    static public function getUltEmailR($referencia) {

        $email = Doctrine::getTable("Email")
                ->createQuery("e")
                ->select("ca_subject")
                ->addWhere("ca_tipo=? and ca_idcaso =?", array('Antecedentes', $referencia))
                ->addOrderBy("e.ca_idemail DESC")
                //->setHydrationMode(Doctrine::HYDRATE_SCALAR)
                ->fetchOne();
        //print_r($email);
        return $email;
    }

    public function getDatosMasterSea() {
        $masterSea = $this->getInoMasterSea();
        $datosMaster = json_decode(utf8_encode($masterSea->getCaDatos()), 1);
        return $datosMaster;
    }

    public function existeReporteOtm() {
        $houses = $this->getInoHouse();
        foreach ($houses as $house) {
            if ($house->getInoHouseSea()->getCaContinuacion() != "N/A" && $house->getInoHouseSea()->getCaContinuacion() != "") {
                return true;
            }
        }
        return false;
    }

    public function getTarea1207($datosMaster) {
        $idTarea = $datosMaster["idtarea"];
        if (!$idTarea) {
            //if ($this->existeReporteOtm()) {
                return true;
            //}
        }
        return false;
    }

    public function getCargaTotal() {
        $houses = $this->getInoHouse();
        $carga = 0;
        foreach ($houses as $house) {
            if ($this->getCaTransporte() == Constantes::AEREO) {
                $carga += $house->getCaPeso();
            } else {
                $carga += $house->getCaVolumen();
            }
        }
        return $carga;
    }

    public function generarComisiones() {
        $datosMaster = json_decode(utf8_encode($this->getCaDatos()), 1);
//      if ($this->getCaImpoexpo() !== Constantes::OTMDTA || ($this->getCaImpoexpo() == Constantes::OTMDTA && $datosMaster['idempresa'] == 2)) {  // $this->getCaImpoexpo() !== Constantes::INTERNO &&  && $this->getCaTransporte() !== Constantes::TERRESTRE
            
        $houses = $this->getInoHouse();
        foreach ($houses as $house) {
            if ($this->getCaImpoexpo() == Constantes::OTMDTA) {
                /* Oct 06/2020 Causación Comisiones COLOTM solo para vendedores de COLOTM u OTMs directos de Coltrans  */
                if ($datosMaster['idempresa'] == 8 && $house->getVendedor()->getSucursal()->getCaIdempresa() != 8) {
                    continue;
                } else if ($datosMaster['idempresa'] == 2 && $house->getVendedor()->getSucursal()->getCaIdempresa() == 8) {
                    continue;
                }
            }
            if ($house->getUtilidadPorHouse()) {
                if ((($this->getCaImpoexpo() == Constantes::IMPO || $this->getCaImpoexpo() == Constantes::TRIANGULACION) && $this->getCaTransporte() == Constantes::MARITIMO) || $this->getCaImpoexpo() == Constantes::EXPO) {
                    $this->causarComision(null, $house, $house->getUtilidadPorHouse());     /* Causa la utilidad general del caso para Impo Marítimo */
                }
                if ($this->getCaImpoexpo() != Constantes::INTERNO && ($this->getCaTransporte() == Constantes::TERRESTRE || $this->getCaImpoexpo() == Constantes::OTMDTA)) {
                    $this->causarComision(null, $house, $house->getUtilidadPorHouse());     /* Causa la utilidad general para los OTM DIRECTOS */
                }
            } else {
                $this->causarComision(null, $house, $house->getIno());      /* Causa la utilidad general del caso para diferentes a Impo Aéreo */
            }
            $individual = 0;     /* Remiendo para Causar Comisiones de INO Ver. Terrestre */
            $utilidades = $house->getInoUtilidad();
            foreach ($utilidades as $utilidad) { /* Causa la utilidad individual para Impo Aéreo, Terrestre Interno y sobreventas de Impo Marítimo */
                if (!$utilidad->getCaUsuanulado()) {
                    $this->causarComision($utilidad->getCaIdutilidad(), $house, $utilidad->getCaValor());
                    $individual += $utilidad->getCaValor();
                } else {
                    $conn = Doctrine::getTable("InoComision")->getConnection();
                    $sql = "delete from ino.tb_comisiones where ca_consecutivo IS NULL and ca_idutilidad = " . $utilidad->getCaIdutilidad();
                    $stmt = $conn->execute($sql);
                    $sql = "select sum(ca_comision) as ca_comision from ino.tb_comisiones where ca_idutilidad = " . $utilidad->getCaIdutilidad();
                    $stmt = $conn->execute($sql);
                    $comision = $stmt->fetchAll(PDO::FETCH_COLUMN);
                    if ($comision[0] <> 0) {
                        /* Valida si el ingreso individual fue anulado y realizar el ajuste */
                        $reversion = new InoComision();
                        $reversion->setCaIdhouse($utilidad->getCaIdhouse());
                        $reversion->setCaIdutilidad($utilidad->getCaIdutilidad());
                        $reversion->setCaValor($utilidad->getCaValor());
                        $reversion->setCaComision(-$comision[0]);
                        $reversion->setCaVendedor($house->getCaVendedor());
                        $reversion->save();
                    }
                }
            }
            if ($this->getCaImpoexpo() == Constantes::INTERNO && ($house->getUtilidadPorHouse() - $individual) != 0) {
                /* Solo aplica para Terrestre Interno, causa comision si hay diferencia entre ingreso individual e ingreso general*/
                $this->causarComision(null, $house, $house->getUtilidadPorHouse() - $individual);
            }
        }
//      }
        return true;
    }

    public function causarComision($idutilidad, &$house, $utilidad) {
        // $conn = Doctrine_Manager::getInstance()->connection();
        $porcentaje = 10;   /* FIX-ME - Comisión por defecto */

        $q = Doctrine::getTable("InoComision")
                ->createQuery("c")
                ->addWhere("c.ca_idhouse = ? ", $house->getCaIdhouse());
        if ($idutilidad) {
            $q->addWhere("c.ca_idutilidad = ?", $idutilidad);
        } else {
            $q->addWhere("c.ca_idutilidad IS NULL");
        }
        $comision = $q->fetchOne(); // Busca si hay un registro correpondiente a esta comision

        $vlr_comision = round($utilidad * $porcentaje / 100, 0);
        // $conn->beginTransaction();
        // try {
            if ($comision) {    // Si lo encuentra, significa que hubo una causacion previa que puede o no, estar paga
                $tot_pagado = InoComisionTable::getTotalPagado($house->getCaIdhouse(), $idutilidad);    // Determina cuanto se ha pagado en comprobantes por esta comision

                $diferencia = $vlr_comision - $tot_pagado;  // Calcula diferencia entre lo que se ha pagado en comprobantes y lo que corresponde a la comision
                if ($comision->getCaVendedor() != $house->getCaVendedor()) {   // Detecta un cambio de Vendedor
                    if ($comision->getCaConsecutivo()) {    // Si ya se generó el comprobante, crea un nuevos registros
                        $reversion = new InoComision();
                        $reversion->setCaIdhouse($comision->getCaIdhouse());
                        $reversion->setCaIdutilidad($idutilidad);
                        $reversion->setCaValor($utilidad);
                        $reversion->setCaComision(-$vlr_comision);
                        $reversion->setCaVendedor($comision->getCaVendedor());
                        $reversion->save();

                        $ajuste = new InoComision();
                        $ajuste->setCaIdhouse($comision->getCaIdhouse());
                        $ajuste->setCaIdutilidad($idutilidad);
                        $ajuste->setCaValor($utilidad);
                        $ajuste->setCaComision($vlr_comision);
                        $ajuste->setCaVendedor($house->getCaVendedor());
                        $ajuste->save();
                    } else {
                        $comision->setCaComision($vlr_comision);
                        $comision->setCaVendedor($house->getCaVendedor());
                        $comision->save();
                    }
                    // $conn->commit();
                    return;
                } else if ($diferencia) {   // Detecta diferencia entre lo pagado en comprobantes y el valor actual de comisión
                    $q = Doctrine::getTable("InoComision")  // Valida si ya hay un ajuste sin comprobante para ese house y ese concepto
                            ->createQuery("c")
                            ->addWhere("c.ca_idhouse = ?", $house->getCaIdhouse())
                            ->addWhere("c.ca_consecutivo IS NULL");
                    if ($idutilidad) {
                        $q->addWhere("c.ca_idutilidad = ?", $idutilidad);
                    } else {
                        $q->addWhere("c.ca_idutilidad IS NULL");
                    }
                    $comision = $q->fetchOne();     // Localiza si hay un registro de la causacion sin consecutivo para ajustar, en su defecto crea uno nuevo para el ajuste

                    if (!$comision) {    // Si ya se generó el comprobante, crea un nuevo registro
                        $comision = new InoComision();
                    }
                    $vlr_comision = $diferencia;
                } else {
                    $q = Doctrine::getTable("InoComision")  // Valida si ya hay un ajuste sin comprobante para ese house y ese concepto
                            ->createQuery("c")
                            ->addWhere("c.ca_idhouse = ?", $house->getCaIdhouse())
                            ->addWhere("c.ca_consecutivo IS NULL");
                    if ($idutilidad) {
                        $q->addWhere("c.ca_idutilidad = ?", $idutilidad);
                    } else {
                        $q->addWhere("c.ca_idutilidad IS NULL");
                    }
                    $comision = $q->fetchOne();

                    if ($comision) {    // Elimina cualquier causacion si comprobante ya que no hay diferencia entre la comision y el total pagado
                        $comision->delete();
                        // $conn->commit();
                    }
                    return;              // Al no haber diferencia, no realiza ningun ajuste
                }
            } else {
                $comision = new InoComision();
            }
            
            if ($vlr_comision != 0 and $comision->getCaComision() != $vlr_comision) {
                /*
                if ($house->getCaIdhouse() == 57148) {
                    echo "<pre>";
                    print_r(array("Idcomision" => $comision->getCaIdcomision(), "CaComision" => $comision->getCaComision(), "House" => $house->getCaIdhouse(), "idutilidad" => $idutilidad, "utilidad" => $utilidad, "vlr_comision" => $vlr_comision, "tot_pagado" => $tot_pagado, "diferencia" => $diferencia));
                    echo "</pre>";
                }*/
                $comision->setCaIdhouse($house->getCaIdhouse());
                $comision->setCaIdutilidad($idutilidad);
                $comision->setCaValor($utilidad);
                $comision->setCaComision($vlr_comision);
                $comision->setCaVendedor($house->getCaVendedor());
                $comision->save();
                // $conn->commit();
            }
        // } catch (Exception $e) {
            // print_r($e->getMessage());
            // $conn->rollback();
        // }
    }

    public function getFchUltimoEvento($impoexpo){        
        
        $datosMaster = json_decode($this->getCaDatos());            
        $eventos = $this->getInfoEventos($impoexpo);

        $ult_mem = $eventos["ult_mem"];
        $sae_mem = $eventos["sae_mem"];
        $rad_mem = $eventos["rad_mem"];

        $nomsia = $datosMaster->agencia == "830003960"?$datosMaster->agencia:null;
        if ($nomsia) {
            $matriz_eventos["intervalo_1"]['Rec.Último Documento'] = $ult_mem;
            $matriz_eventos["intervalo_1"]['SAE'] = $sae_mem;
        } else {
            if (!is_null($sae_mem) and $nom_sia == '830003960' and $tip_tra == 'Marítimo') {
                $matriz_eventos["intervalo_1"]['SAE'] = $sae_mem;
            } else {
                $matriz_eventos["intervalo_1"]['Rec.Último Documento'] = $ult_mem;
            }
            $matriz_eventos["intervalo_1"]['Radicación Documento de Transporte'] = $rad_mem;
        }
        
        return $matriz_eventos["intervalo_1"]['Rec.Último Documento']!=null?$matriz_eventos["intervalo_1"]['Rec.Último Documento']:null;                
    }
    
    public function getInfoEventos($impoexpo){
        
        if($impoexpo == Constantes::EXPO){            
            $innerJoin = "INNER JOIN tb_brk_expo be ON be.ca_referencia = ext.ca_referencia "
                       . "INNER JOIN tb_parametros prm ON (prm.ca_casouso = 'CU011' and be.ca_idregimen = prm.ca_identificacion)";
        }else{            
            $innerJoin = "INNER JOIN (select ca_referencia, (ca_datos->>'modalidad')::int as ca_tipoexpo from ino.tb_master) reg ON reg.ca_referencia = ext.ca_referencia "
                       . "INNER JOIN tb_parametros prm ON (prm.ca_casouso = 'CU011' and reg.ca_tipoexpo = prm.ca_identificacion)";
        }
        
        $conn = Doctrine_Manager::getInstance()->getConnection('master');
        $sql = "
            SELECT ext.ca_referencia as ca_referencia, ext.ca_idevento as ca_idevento, ca_fchevento, ca_usuario , pre.ca_valor, ca_fechadoc
            FROM tb_expo_tracking  ext
                LEFT OUTER JOIN (
                    SELECT DISTINCT ca_referencia as ca_referencia_aed, ca_idevento, min(ca_fechadoc) as ca_fechadoc 
                    FROM tb_expo_aedex group by ca_referencia, ca_idevento) aed ON (aed.ca_referencia_aed = ext.ca_referencia and aed.ca_idevento = ext.ca_idevento)
                $innerJoin                  
                INNER JOIN tb_parametros pre ON (pre.ca_casouso = prm.ca_valor2 and pre.ca_identificacion = ext.ca_idevento)
            WHERE ca_realizado = 1 and ext.ca_referencia = '".$this->getCaReferencia()."'";

        $st = $conn->execute($sql);
        $eventos = $st->fetchAll();

        $no_docs = ["SAE", "DEX", "Cancelación Póliza Seguro", "Radicación Documento de Transporte", "Recibo de Soportes desde Puerto"];

        $rad_mem = null;
        $sae_mem = null;
        $ult_mem = null;

        $tbeventos = "<table>";
        $arreventos = [];
        foreach($eventos as $evento){

            $tbeventos.= "<tr>";
            $tbeventos.= "  <td style='font-size: 9px;'>" . utf8_encode($evento['ca_valor']) . "</td>";
            $tbeventos.= "  <td style='font-size: 9px;'>" . $evento['ca_usuario'] . "</td>";
            $ult_mem = (!in_array($evento['ca_valor'], $no_docs) and $evento['ca_fchevento'] > $ult_mem) ? $evento['ca_fchevento'] : $ult_mem;
            if ($evento['ca_valor'] == 'Radicación Documento de Transporte') {
                $fch_tmp = $rad_mem = $evento['ca_fchevento'];
            } else if ($evento['ca_valor'] == 'SAE') {
                $fch_tmp = $sae_mem = $evento['ca_fechadoc'];
            } else {
                $fch_tmp = $evento['ca_fchevento'];
            }
            $tbeventos.= "  <td style='font-size: 9px;'>$fch_tmp</td>";
            $tbeventos.= "</tr>";
            $arrayeventos = array("ca_evento"=>utf8_encode($evento['ca_valor']), "ca_usuario"=>$evento['ca_usuario'], "ca_fchevento"=>$fch_tmp);            
        }
        $tbeventos.= "  </table>";
        return array("ult_mem"=>$ult_mem, "sae_mem"=>$sae_mem, "rad_mem"=>$rad_mem, "tb_eventos"=>$tbeventos, "arrayEventos"=>$arrayeventos);
    }
    
    public function getRequiereIdg($idetapa){
        
        $datos = json_decode(utf8_encode($this->getCaDatos()));
        
        if($this->getCaImpoexpo() == Constantes::EXPO){
            switch($datos->idg){
                case "SI":
                case "Si":                    
                case "FACTURA AL AGENTE":
                    if($idetapa=="EEETD")
                        return false;
                    else
                        return true;
                    break;
                case "COLLECT":
                    if($idetapa=="EEETD")
                        return true;
                    else
                        return false;
                    break;
                case "NO":
                    return false;
                    break;
                case "":
                    return true;
                    break;
            }
        } else if($this->getCaImpoexpo() == Constantes::TRIANGULACION || $this->getCaImpoexpo() == Constantes::INTERNO || $this->getCaImpoexpo() == Constantes::OTMDTA) {
            return false;
        } else{
            return true;
        }
    }
    
    public function getFacturasIngreso(){
        
        return Doctrine::getTable("InoComprobante")                    
                    ->createQuery("c")
                    ->select("*")
                    ->innerJoin("c.InoHouse h")
                    ->innerJoin("c.InoTipoComprobante t")                    
                    ->addWhere("h.ca_idmaster = ? ", $this->getCaIdmaster())
                    ->addWhere("t.ca_tipo =?", "F")
                    ->addWhere("c.ca_fchanulado is null")
                    ->addWhere("c.ca_estado in (5)")
                    ->execute();
    }
    
    public function autorizarCierreReferencia(){
        
        $this->setDatosJson("cierre",true);
        $this->setCaObservaciones($this->getCaObservaciones()."\n. Auditoría autoriza cierre de referencia. Más información en la opción de Auditoría.");
        $this->save();        
    }
    
    public function getIdsExpo($tipo){
        
        if ($tipo != "Aduana") {
            return Doctrine::getTable("InoHouse")
                            ->createQuery("h")
                            ->innerJoin("h.Cliente c")
                            ->where("ca_idmaster = ?", $this->getCaIdmaster())
                            ->fetchOne();
        } else {
            return Doctrine::getTable("InoMaestraAdu")
                            ->createQuery("ad")
                            ->innerJoin("ad.Cliente c")
                            ->where("ca_referencia = ?", $this->getCaReferencia())
                            ->fetchOne();
        }
    }
}