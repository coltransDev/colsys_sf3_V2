<?php
/**
 * Reporte
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    ##PACKAGE##
 * @subpackage ##SUBPACKAGE##
 * @author     ##NAME## <##EMAIL##>
 * @version    SVN: $Id: Builder.php 5845 2009-06-09 07:36:57Z jwage $
 */
class Reporte extends BaseReporte {

    private $ultimoStatus = null;
    private $inoClientesSea = null;
    private $proveedoresStr = null;
    private $editable = null;
    private $nversiones = null;
    private $ultimaVersion = null;
    private $repExterior = null;
    private $cerrado = null;
    private $cliente = null;
    private $esUltimaVersion = null;
    private $repAnterior = null;

    const IDLISTASEG = 3;
    const IDLISTACONS = 6;
    /*
     * Retorna el objeto Contacto asociado al reporte
     * @author Andres Botero
     */
    public function getContacto($tipo='0') {
        if($this->getCaTiporep()==4)
        {
            if($tipo=='4')//contacto No fijo
                return Doctrine::getTable("Contacto")->find($this->getCaIdconcliente());
            if($tipo=='5'){
                $contac=array();
                $usuarios = Doctrine::getTable("Usuario")
                        ->createQuery("u")
                        ->addWhere("u.ca_departamento = 'OTM' and u.ca_activo=true ")
                        ->addOrderBy("u.ca_email")
                        ->execute();
                foreach ($usuarios as $usuario) {
                    $contac[] = array("ca_login" => $usuario->getCaLogin(),"ca_nombre" => $usuario->getCaNombre());
                }
                return $contac;
            }
            if(!$this->cliente)
                $this->getCliente();
            if(!$this->cliente)
                    $this->cliente=new Tercero();
            $contacto=new Contacto();
            $contacto->setCaEmail($this->cliente->getCaEmail());
            $contacto->setCaNombres($this->cliente->getCaCompania());
            $contacto->setCaIdcliente($this->cliente->getCaIdcliente());
            $contacto->setCaFijo("true");
            $contacto->setCaTelefonos($this->cliente->getCaTelefonos());
            $contacto->setCaCargo($this->cliente->getCaEmail());
            $contacto->setCliente($this->cliente);
            if($tipo=='2')
                return $contacto;
            else
                return array($contacto);
        }
        else
        {
            if($tipo!='1' && $tipo!='3' && $tipo!='5')//contacto No fijo
                return Doctrine::getTable("Contacto")->find($this->getCaIdconcliente());
            else if($tipo=='1'){//CONTACTO FIJO
                if(!$this->cliente)
                     $this->getCliente();   
                return  Doctrine::getTable("Contacto")
                                       ->createQuery("c")
                                       ->addWhere("c.ca_idcliente = ?", $this->cliente->getCaIdcliente() )
                                       ->addWhere("ca_cargo != ?", 'Extrabajador')
                                       ->addWhere("ca_fijo = ?", true)
                                       ->execute();
            }else if($tipo=='3'){//CONTACTO Internos coltrans
                $contac=array();
                $contacts=explode(",",$this->getCaConfirmarClie());
                foreach($contacts as $c)
                {
                    if (stripos(strtolower($c), '@coltrans.com.co') !== false || stripos(strtolower($c), '@colmas.com.co') !== false || stripos(strtolower($c), '@colotm.com') !== false)
                    {
                        $contac[]["ca_email"]=$c;
                    }
                }
                return $contac;
            }else if($tipo=='5'){//CONTACTO Operativos coltrans de la sucursal
                $contac=array();
                $usuarios = Doctrine::getTable("Usuario")
                        ->createQuery("u")
                        ->innerJoin("u.Sucursal s")
                        ->addWhere("u.ca_departamento = ? and u.ca_activo=true ", array($this->getCaTransporte()))
                        ->addWhere("s.ca_nombre = ?", $this->getUsuario()->getSucursal()->getCaNombre())
                        ->addOrderBy("u.ca_email")
                        ->execute();
                foreach ($usuarios as $usuario) {
                    $contac[] = array("ca_login" => $usuario->getCaLogin(),"ca_nombre" => $usuario->getCaNombre());
                }
                return $contac;
            }            
        }
    }    
    /*
     * Retorna el objeto cliente asociado al contacto del reporte
     * @author Andres Botero
     */
    public function getCliente($opciontmp=null) {
        if(!$this->cliente)
        {
            if($this->getCaTiporep()==4 && ($this->getRepOtm()->getCaIdimportador()!="" || $this->getRepOtm()->getCaIdcliente()!="" ) )
            {
                $this->cliente = new Cliente();
                $idt=($opciontmp=="continuacion")?$this->getRepOtm()->getCaIdimportador():(($this->getRepOtm()->getCaIdcliente()!="")?$this->getRepOtm()->getCaIdcliente():$this->getRepOtm()->getCaIdimportador());
                $tercero=Doctrine::getTable("Tercero")->find($idt);
                if($tercero)
                {
                    $this->cliente->setCaIdcliente($tercero->getCaIdtercero());
                    list($nit,$digito)=  explode("-",$tercero->getCaIdentificacion() );
                    $this->cliente->setCaIdalterno(trim($nit));
                    $this->cliente->setCaDigito(trim($digito));
                    $this->cliente->setCaCompania($tercero->getCaNombre());
                    $this->cliente->setCaEmail($tercero->getCaEmail());
                    $this->cliente->setCaTelefonos($tercero->getCaTelefonos());
                    $this->cliente->setCaFax($tercero->getCaFax());
                    $this->cliente->setCaIdciudad($tercero->getCaIdciudad());
                    $this->cliente->setCaPropiedades($tercero->getCaPropiedades());
                    $this->cliente->setProperty("tipopersona",$tercero->getCaTipopersona());
                }
            }
            else
            {
                $this->cliente=Doctrine::getTable("Cliente")
                    ->createQuery("cl")
                    ->innerJoin("cl.Contacto c")
                    ->where("c.ca_idcontacto = ?", $this->getCaIdconcliente())
                    ->distinct()
                    ->fetchOne();
            }
        }
        return $this->cliente;
    }

    /*
     * Retorna verdadero si es la ultima version del reporte de lo contrario retorna falso
     * Author: Andres Botero
     */
    public function esUltimaVersion($modo='') {
        if( $this->esUltimaVersion===null ){
            $add="";
            $version = $this->getCaVersion();            
            if($modo=="maritimo")
            {
                $add="and ca_tiporep in (1,2,3)";
                //echo $this->getCaConsecutivo()."::".$add;
            }
            $count = Doctrine::getTable("Reporte")
                            ->createQuery("r")
                            ->select("count(*) as count")
                            ->where("r.ca_consecutivo = ? AND r.ca_version> ? AND r.ca_fchanulado IS NULL ". $add, array($this->getCaConsecutivo(), $version))
                            ->setHydrationMode(Doctrine::HYDRATE_SINGLE_SCALAR)
                            ->execute();

            if ($count > 0) {
                $this->editable = false;
                $this->esUltimaVersion = false;                
            } else {
                $this->editable = true;
                $this->esUltimaVersion = true;                
            }
        }
        return $this->esUltimaVersion;
    }

    /*
     * Retorna el color de acuerdo al estado que se encuentra en este momento la carga
     * @author: Andres Botero
     */

    public function getColorStatus() {
        if($this->getCaUsucreado()=="web")
        {
            return "orange1";
        }
        $etapa = $this->getTrackingEtapa();
        if ($etapa && $etapa->getCaClass()) {
            return $etapa->getCaClass();
        }

        if (Utils::parseDate($this->getCaFchultstatus(), "Y-m-d") == date("Y-m-d")) {
            return "green";
        }
        return "";
    }

    /*
     * Retorna un array conteniendo los proovedores del reporte
     * Author: Andres Botero
     */

    public function getProveedores() {

        if ($this->getCaImpoexpo() == Constantes::IMPO || $this->getCaImpoexpo() == Constantes::TRIANGULACION || $this->getCaImpoexpo() == Constantes::OTMDTA1 || $this->getCaImpoexpo() == Constantes::OTMDTA) {
            $provId = $this->getCaIdproveedor();
            if ($provId) {
                $provId = explode("|", $provId);
                $proveedores = Doctrine::getTable("Tercero")
                                ->createQuery("t")
                                ->whereIn("t.ca_idtercero", $provId)
                                ->execute();
                return $proveedores;
            }
        }
        return null;
    }

    /*
     * Retorna un String conteniendo los proovedores del reporte
     * Author: Andres Botero
     */

    public function getProveedoresStr($dir=false) {

        if ($this->proveedoresStr == null) {
            $proveedoresStr = "";
            $proveedores = $this->getProveedores();
            if ($proveedores) {
                foreach ($proveedores as $proveedor) {
                    if ($proveedoresStr) {
                        $proveedoresStr.=" - ";
                    }
                    $proveedoresStr.= $proveedor->getCaNombre().(($dir!=false)?"<br>".htmlentities($proveedor->getCaDireccion()):"");
                }
            }
            $this->proveedoresStr = $proveedoresStr;
        }
        return $this->proveedoresStr;
    }

    /*
     * Retorna el objeto InoClientesSea asociado al reporte
     * @author Andres Botero
     */

    public function getInoClientesSea() {
        if (!$this->inoClientesSea) {
            $this->inoClientesSea = Doctrine::getTable("InoClientesSea")
                            ->createQuery("c")
                            ->innerJoin("c.Reporte r")
                            ->where("r.ca_consecutivo = ?", $this->getCaConsecutivo())
                            ->fetchOne();
        }
        return $this->inoClientesSea;
    }

    /*
     * Retorna el ultimo status segun el orden cronologico
     * Author: Andres Botero
     */

    public function getUltimoStatus() {
        if( $this->ultimoStatus===null ){
            $this->ultimoStatus = Doctrine::getTable("RepStatus")
                            ->createQuery("s")
                            ->innerJoin("s.Reporte r")
                            ->where("r.ca_consecutivo = ?", $this->getCaConsecutivo())
                            ->addOrderBy("s.ca_fchenvio DESC")
                            ->limit(1)
                            ->fetchOne();
        }
        return $this->ultimoStatus;
    }

    /*     * **************************************************************
     *
     * ************************************************************** */

    /*
     * Retorna la fecha del ultimo status, avisos, referencia, otm, etc.
     * @author Andres Botero
     */

    public function getFchUltimoStatus($format="Y-m-d") {
        return $this->getCaFchultstatus($format);
    }

    /*
     * Retorna el objeto InoClientesAir asociado al reporte
     * @author Andres Botero
     */

    public function getInoClientesAir() {
        return Doctrine::getTable("InoClientesAir")
            ->createQuery("c")
            ->addWhere("c.ca_idreporte=?",  $this->getCaConsecutivo())
            ->fetchOne();
    }

    /*
     * Retorna el ultimo texto en status, avisos, referencia, otm, etc.
     * @author Andres Botero
     */

    public function getTextoStatus() {
        $status = $this->getUltimostatus();

        if ($status) {
            return $status->getStatus();
        }
    }

    /*
     * Retorna el numero de versiones existentes de este reporte
     * Author: Andres Botero
     */

    public function numVersiones() {

        if (!$this->nversiones) {
            $count = Doctrine::getTable("Reporte")
                            ->createQuery("r")
                            ->select("count(*)")
                            ->where("r.ca_consecutivo = ?", $this->getCaConsecutivo())
                            ->setHydrationMode(Doctrine::HYDRATE_SINGLE_SCALAR)
                            ->execute();

            $this->nversiones = $count;
        }

        return $this->nversiones;
    }

    /*
     * Retorna el numero de versiones existentes de este reporte
     * Author: Andres Botero
     */

    public function getUltVersion() {

        if (!$this->ultimaVersion) {
            $count = Doctrine::getTable("Reporte")
                            ->createQuery("r")
                            ->select("r.ca_version")
                            ->where("r.ca_consecutivo = ? AND ca_fchanulado IS NULL", $this->getCaConsecutivo())
                            ->orderBy("r.ca_version DESC")
                            ->limit(1)
                            ->setHydrationMode(Doctrine::HYDRATE_SINGLE_SCALAR)
                            ->execute();
            $this->ultimaVersion = $count;
        }
        return $this->ultimaVersion;
    }
    
    public function getRepUltVersion() {
        return Doctrine::getTable("Reporte")
                        ->createQuery("r")
                        ->select("*")
                        ->where("r.ca_consecutivo = ? AND ca_fchanulado IS NULL", $this->getCaConsecutivo())
                        ->orderBy("r.ca_version DESC")
                        ->limit(1)
                        ->fetchOne();        
    }

    /*
     * Retorna si el reporte puede ser modificado o no
     * Author: Mauricio Quinche
     */

    public function getEditable($permiso=0, $user=null) {
        if ($permiso < 4 && $this->getCaTiporep()!=4 ) {
            
            if ($this->esUltimaVersion()) {
                
                if ($this->getCerrado()) {
                    $this->editable = false;
                } else {
                    
                    if ($this->existeReporteExteriorVersionActual()) {
                        $this->editable = false;
                    } else {
                        if ($user->getUserId() != $this->getCaUsucreado()) {
                            $this->editable = false;
                        }
                        else
                            $this->editable = true;
                    }
                    /*$repAntecedentes=$this->getRepAntecedentes();
                    if($repAntecedentes)
                    {
                        if($repAntecedentes->getCaEstado()!="R")
                            $this->editable = false;                       
                    }*/
                }
            }
        }else
            $this->editable = true;
        return $this->editable;
    }

    /*
     * Retorna si esta cerrado un reporte
     * Author: mauricio Quinche
     */

    public function getCerrado() {
        if ($this->getCaFchcerrado() || $this->getCaUsucerrado())
            $this->cerrado = true;
        else
            $this->cerrado = false;

        return $this->cerrado;
    }

    public function getAnulado() {
        if ($this->getCaFchanulado() || $this->getCaUsuanulado())
            return true;
        else
            return false;
    }

    /*
     * Retorna los equipos asociados al reporte
     * Author: Andres Botero
     */

    public function getRepEquipos() {
        return Doctrine::getTable("RepEquipo")
                ->createQuery("e")
                ->select("e.*")
                ->innerJoin("e.Reporte r")
                ->where("r.ca_consecutivo = ? ", $this->getCaConsecutivo())
                ->execute();
    }

    /*
     * Retorna los status asociasdos al reporte , sobrecarga getRepStatus en BaseReporte
     * Author: Andres Botero
     */

    public function getRepStatus() {

        return Doctrine::getTable("RepStatus")
                ->createQuery("s")
                ->innerJoin("s.Reporte r")
                ->where("r.ca_consecutivo = ? and ca_tipo in (0,2)", $this->getCaConsecutivo())
                ->addOrderBy("s.ca_fchenvio DESC")
                ->execute();
    }

    /*
     * Retorna el objeto Tercero de tipo consignatario asociado al reporte
     * @author Andres Botero
     */

    public function getConsignatario() {
        if ($this->getCaIdconsignatario()) {
            $consignee = Doctrine::getTable("Tercero")->find($this->getCaIdconsignatario());
            return $consignee;
        } else {
            return null;
        }
    }
    
    public function getImportador() {
        if ($this->getProperty("idimportador")!="") {
            $consignee = Doctrine::getTable("Tercero")->find($this->getProperty("idimportador"));
            return $consignee;
        } else {
            return null;
        }
    }

    public function getRepresentante() {
        if ($this->getCaIdrepresentante()) {
            $consignee = Doctrine::getTable("Tercero")->find($this->getCaIdrepresentante());
            return $consignee;
        } else {
            return null;
        }
    }

    /*
     * Retorna el objeto Tercero de tipo notify asociado al reporte
     * @author Andres Botero
     */

    public function getNotify() {
        $consignee = Doctrine::getTable("Tercero")->find($this->getCaIdnotify());
        return $consignee;
    }

    /*
     * Retorna los objetos RepGasto asociados al reporte
     * @author Andres Botero
     */

    public function getRecargos($tipo=null) {
        if($tipo!=constantes::OTMDTA)
        {
            $q = Doctrine::getTable("RepGasto")
                            ->createQuery("r")
                            ->innerJoin("r.TipoRecargo tr")
                            ->addWhere("r.ca_idreporte = ? ", $this->getCaIdreporte());
            if($tipo!= null)
            {
                $q->addWhere("r.ca_idrecargo!=61");
            }
            
            if ($this->getCaImpoexpo() != Constantes::EXPO) {
                if ($tipo == "local") {
                    $q->addWhere("r.ca_recargoorigen = ?", false);
                }

                if ($tipo == "origen") {
                    $q->addWhere("r.ca_recargoorigen = ?", true);
                }
            }
            $q->orderBy("tr.ca_recargo");
        }
        else
        {
             $q = Doctrine::getTable("RepGasto")
                             ->createQuery("t")
                             ->leftJoin("t.Concepto c")
                             ->leftJoin("t.Equipo e")
                             ->where("t.ca_idreporte = ?", $this->getCaIdreporte())
                             ->addWhere("t.ca_idrecargo=61")
                             ->orderBy("c.ca_concepto");
        }
        $gastos = $q->execute();

        return $gastos;
    }

    public function getRepTarifa($tipo='1') {
        $q = Doctrine::getTable("RepTarifa")
                ->createQuery("t")
                ->innerJoin("t.Concepto c")
                ->where("t.ca_idreporte = ? and t.ca_idconcepto!=9999 and ca_tipo = ? ", array($this->getCaIdreporte(),$tipo))
                ->orderBy("to_char(t.ca_idconcepto, '999')")
                ->execute();
        return $q;
    }

    /*
     * Retorna los objetos RepCosto asociados al reporte
     * @author Andres Botero
     */

    public function getCostos() {

        $q = Doctrine::getTable("RepCosto")
                        ->createQuery("c")
                        ->innerJoin("c.Costo co")
                        ->orderBy("c.ca_fchcreado ASC");
        $q->addWhere("c.ca_idreporte = ? ", $this->getCaIdreporte());
        return $q->execute();
    }
    
    public function getEsOtm() {
        if($this->getCaContinuacion()=="OTM" ||  $this->getCaContOrigen()!="" || $this->getCaImpoexpo()==Constantes::OTMDTA1 || $this->getCaImpoexpo()==Constantes::OTMDTA)
        {
            //echo $this->getCaImpoexpo();
            return true;
        }
        else
        {
            $nreg = Doctrine::getTable("RepTarifa")
                        ->createQuery("g")
                        ->select("count(*) as nreg")
                        ->addWhere("g.ca_tipo = ? and ca_idreporte=?", array("2",$this->getCaIdreporte()))
                        ->setHydrationMode(Doctrine::HYDRATE_SINGLE_SCALAR)
                        ->execute();
            if($nreg>0)
            {
                return true;
            }
        }
        return false;
    }
    
    
     /*
     * Retorna un boolean true o false para indicar si posee seguro
     * @author Mauricio Quinche
     */
    public function getEsSeguro() {
        if ($this->getCaSeguro() == "Sí") {        
            return true;
        }
        else
        {
            $conceptos=array();
            $c= ParametroTable::retrieveByCaso("CU237");
            foreach($c as $s)
            {
                $conceptos[]=$s->getCaValor();                        
            }

            $nreg = Doctrine::getTable("RepGasto")
                ->createQuery("r")
                ->select("count(*) as nreg")
                ->addWhere("r.ca_idreporte = ? ", $this->getCaIdreporte())
                ->andWhereIn("r.ca_idrecargo", $conceptos)
                ->setHydrationMode(Doctrine::HYDRATE_SINGLE_SCALAR)
                ->execute();

            if($nreg>0)
            {
                return true;
            }
        }
        return false;
    }

    /*
     * Retorna el objetos RepAduana asociados al reporte
     * @author Andres Botero
     */

    public function getRepAduana(PropelPDO $con = null) {

        $repaduana = Doctrine::getTable("RepAduana")
                        ->createQuery("a")
                        ->where("a.ca_idreporte = ? ", $this->getCaIdreporte())
                        ->fetchOne();

        if (!$repaduana) {
            $repaduana = new RepAduana();
        }
        return $repaduana;
    }

    /*
     * Retorna el objetos RepSeguro asociados al reporte
     * @author Andres Botero
     */

    public function getRepSeguro(PropelPDO $con = null) {

        $repseguro = Doctrine::getTable("RepSeguro")
                        ->createQuery("s")
                        ->where("s.ca_idreporte = ?", $this->getCaIdreporte())
                        ->fetchOne();

        if (!$repseguro) {
            $repseguro = new RepSeguro();
        }
        return $repseguro;
    }

    /*
     * Retorna el objetos RepExpo asociados al reporte
     * @author Andres Botero
     */

    public function getRepExpo(PropelPDO $con = null) {
        $repexpo = Doctrine::getTable("RepExpo")
                        ->createQuery("e")
                        ->where("e.ca_idreporte = ?", $this->getCaIdreporte())
                        ->fetchOne();

        if (!$repexpo) {
            $repexpo = new RepExpo();
        }
        return $repexpo;
    }

    /*
     * Devuelve la ubicacion del directorio donde se encuentran los archivos de la referencia
     * @author Andres Botero
     */

    public function getCotizacion() {
        return Doctrine::getTable("Cotizacion")
                ->createQuery("c")
                ->where("c.ca_consecutivo = ?", $this->getCaConsecutivo())
                ->fetchOne();
    }

    /*
     * Retorna valor a quien se le debe consignar la mercancia
     * @author Andres Botero
     */

    public function getConsignar() {
        if ($this->getCaImpoexpo() == constantes::EXPO && $this->getCaIdconsignar()>0) {
            
            if($this->getCaIdconsignar()<=4)
            {
                $consignar = ParametroTable::retrieveByCaso("CU048", null, null, $this->getCaIdconsignar());
                if ($consignar) {
                    return $consignar[0]->getCaValor();
                }
            }
            else
            {
                $tercero = Doctrine::getTable("Tercero")->find($this->getCaIdconsignar());
                if($tercero)
                    return $tercero->getCaNombre();

            }
        }
    }

    /*
     * Retorna valor a quien se le debe consignar la mercancia
     * @author Andres Botero
     */

    public function getConsignarmaster() {
        if($this->getCaTiporep()>0)
            $id=$this->getCaIdconsignarmaster();
        else
            $id =$this->getCaIdmaster();
        
        if ($this->getCaImpoexpo() == constantes::EXPO && $id>0) {
            if($id<5)
            {
                $consignar = ParametroTable::retrieveByCaso("CU048", null, null, $id);

                if ($consignar) {
                    return $consignar[0]->getCaValor();
                }
            }
            else
            {
                $tercero = Doctrine::getTable("Tercero")->find($id);
                if($tercero)
                    return $tercero->getCaNombre();
            }
        }
        else if($id>4)
        {

            $tercero = Doctrine::getTable("Tercero")->find($id);
                if($tercero)
                    return $tercero->getCaNombre();
        }
    }

    /*
     * Retorna valor incoterm de la carga
     * @author Andres Botero
     */

    public function getIncoterm() {
        $c = new Criteria();
        $c->add(ParametroPeer::CA_CASOUSO, "CU021");
        $c->add(ParametroPeer::CA_IDENTIFICACION, $this->ca_incoterm);
        $incoterms = ParametroPeer::doSelectOne($c);

        if ($incoterms) {
            return $incoterms->getCaValor();
        } else {
            return null;
        }
    }

    /*
     * Retorna valor a se debe transladar la mercancia
     * @author Andres Botero
     */

    public function getNombreBodega() {
        $bodega = BodegaPeer::retrieveByPk($this->getCaIdBodega());
        if ($bodega) {
            return $bodega->getCaNombre();
        }
    }

    /*
     * Devuelve el numero de piezas del reporte, en caso de que se haya enlazado con una referencia devuelve
     * los valores de la referencia y omite los del reporte
     * @author Andres Botero
     */

    public function getPiezas() {
        $status = $this->getUltimoStatus();
        if ($status) {
            return str_replace("|", " ", $status->getCaPiezas());
        }
        return null;
    }

    /*
     * Devuelve el peso del reporte, en caso de que se haya enlazado con una referencia devuelve
     * los valores de la referencia y omite los del reporte
     * @author Andres Botero
     */

    public function getPeso() {
        $status = $this->getUltimoStatus();
        if ($status) {
            return str_replace("|", " ", $status->getCaPeso());
        }
        return null;
    }

    /*
     * Devuelve el peso del reporte, en caso de que se haya enlazado con una referencia devuelve
     * los valores de la referencia y omite los del reporte
     * @author Andres Botero
     */

    public function getVolumen() {
        $status = $this->getUltimoStatus();
        if ($status) {
            return str_replace("|", " ", $status->getCaVolumen());
        }
        return null;
    }

    /*
     * Devuelve el Documento de transporte del reporte, en caso de que se haya enlazado con una referencia devuelve
     * los valores de la referencia y omite los del reporte
     * @author Andres Botero
     */

    public function getDoctransporte() {
        $status = $this->getUltimoStatus();
        if ($status) {
            return $status->getCaDoctransporte();
        }
        return null;
    }
    
    public function getCaDocmaster() {
        $status = $this->getUltimoStatus();
        if ($status) {
            return $status->getCaDocmaster();
        }
        return null;
    }

    /*
     * Devuelve el numero de la referencia asociada al reporte
     * @author Andres Botero
     */

    public function getNumReferencia() {
        if ($this->getCaImpoexpo() == "Importación" && $this->getCaTransporte() == "Marítimo") {
            $inoclientesSea = $this->getInoClientesSea();
            if ($inoclientesSea) {
                return $inoclientesSea->getCaReferencia();
            }
        }
    }

    /*
     * Devuelve la fecha estimada de salida del reporte
     * @author Andres Botero
     */

    public function getETS($format="Y-m-d") {
        $status = $this->getUltimoStatus();
        if ($status) {
            return $status->getCaFchsalida($format);
        }
        return null;
    }

    /*
     * Devuelve la fecha estimada de llegada del reporte
     * @author Andres Botero
     */

    public function getETA($format="Y-m-d") {
        $status = $this->getUltimoStatus();
        if ($status) {
            return $status->getCaFchllegada($format);
        }
        return null;
    }

    /*
     * Retorna la fecha de continuacion del ultimo status enviado
     * Author: Andres Botero
     */

    public function getFchLlegadaCont($format="Y-m-d") {
        $status = $this->getUltimoStatus();
        if ($status) {
            return $status->getCaFchcontinuacion($format);
        }
        return null;
    }

    /*
     * Retorna la fecha de continuacion del ultimo status enviado
     * Author: Andres Botero
     */

    public function getIdnave() {
        $status = $this->getUltimoStatus();

        if ($status) {
            return $status->getCaIdnave();
        }
        return null;
    }

    /*
     * Retorna los archivos del directorio especificado
     * @author: Andres Botero
     */

    public function getFiles($name=array(),$not_name=array()) {
        $directory = $this->getDirectorio();
        if (!is_dir($directory)) {
            mkdir($directory, 0777, true);
        }
        if(count($name)>0)
            return sfFinder::type('file')->maxDepth(0)->name($name)->in($directory);
        else if(count($not_name)>0)            
            return sfFinder::type('file')->maxDepth(0)->not_name($not_name)->in($directory);
        else
            return sfFinder::type('file')->maxDepth(0)->in($directory);
    }

    public function getFilesGestDoc() {
        
        $referencia = $this->getNumReferencia();
        $hbl = $this -> getDoctransporte();
        
        $archivos = array();
        
        if($referencia){
            
            $data = array();
            $data["ref1"] = $referencia;
            $data["ref2"] = $hbl;
            $archivos = ArchivosTable::getArchivosActivos($data);            
        }        
        return $archivos;
    }

    /*
     * Agrega un correo a la lista de confirmaciones
     * @author: Andres Botero
     */

    public function addConfirmarClie($address) {
        $str = $this->getCaConfirmarClie();
        if ($str) {
            $str.=",";
        }
        $str.= $address;
        $this->setCaConfirmarClie($str);
    }

    /*
     * Retorna los reportes al exterior
     * Author: Andres Botero
     */

    public function getReporteExterior() {
        if ($this->getCaImpoexpo() == Constantes::IMPO || $this->getCaImpoexpo() == Constantes::TRIANGULACION) {
            //Reportes al exterior
            if ($this->getCaTransporte() == Constantes::MARITIMO || $this->getCaTransporte() == Constantes::TERRESTRE) {
                $tipo = 'Rep.MarítimoExterior';
            } else {
                $tipo = 'Rep.AéreoExterior';
            }

            return Doctrine::getTable("Email")
                    ->createQuery("e")
                    ->select("e.*")
                    ->innerJoin("e.Reporte r")
                    ->where("r.ca_consecutivo = ?", $this->getCaConsecutivo())
                    ->addWhere("e.ca_tipo = ? ", $tipo)
                    ->addOrderBy("e.ca_fchenvio DESC")
                    ->execute();
        }
        return null;
    }

    /*
     * Retorna true si existen reportes al exterior de la version actual
     * Author: Andres Botero
     */

    public function existeReporteExteriorVersionActual() {
        if ($this->getCaImpoexpo() == Constantes::IMPO || $this->getCaImpoexpo() == Constantes::TRIANGULACION) {
            if (!$this->repExterior) {
                //Reportes al exterior
                if($this->getProperty("repexterior")=="1")
                {
                   $this->repExterior=true; 
                }
                else
                {
                
                    if ($this->getCaTransporte() == Constantes::MARITIMO) {
                        $tipo = 'Rep.MarítimoExterior';
                    } else {
                        $tipo = 'Rep.AéreoExterior';
                    }

                    $numReportes = Doctrine::getTable("Email")
                                    ->createQuery("e")
                                    ->select("COUNT(*)")
                                    ->where("e.ca_idcaso = ?", $this->getCaIdreporte())
                                    ->addWhere("e.ca_tipo = ? ", $tipo)
                                    ->setHydrationMode(Doctrine::HYDRATE_SINGLE_SCALAR)
                                    ->execute();
                    $this->repExterior = $numReportes > 0;
                    if($numReportes>0)
                    {
                        $this->setProperty("repexterior","1");
                        $this->stopBlaming();
                        $this->save();
                    }
                }                
            }
            return $this->repExterior;
        }
        return null;
    }

    /*
     * Retorna true si  el reporte es AG
     * Author: Andres Botero
     */

    public function getEsAG() {
        if ($this->getCaColmas() == '') {
            return true;
        } else {
            return false;
        }
    }

    /*
     * Retorna la cadena que indica a quien se consigna el HBL
     * Author: Andres Botero
     */

    public function getConsignedTo() {

        if ($this->getCaIdconsignar() == 1) {
            $consignatario_final = ($this->getCaIdconsignatario() != 0) ? ($this->getConsignatario()?$this->getConsignatario()->getCaNombre():"") : $this->getCliente()->getCaCompania();
            return $consignatario_final;
        } else {
            $str = $this->getBodegaConsignar()->getCaNombre();
            $bodega = $this->getBodega();
            if ($bodega) {
                if ($bodega->getCaTipo() != "Coordinador Lógistico") {
                    $str.=$bodega->getCaTipo() . " " . $bodega->getCaNombre();
                }
            }
            return $str;
        }
    }

    /*
     *
     */

    public function getBodegaConsignar() {
        return Doctrine::getTable("Bodega")->find($this->getCaIdconsignar());
    }

    /*
     * Retorna los usuarios de operativos traficos
     */

    public function getUsuariosOperativos() {
        $usuario=new Usuario();
        
        $usuario = Doctrine::getTable("Usuario")->find($this->getCaUsucreado());
        $q = Doctrine::getTable("Usuario")
                        ->createQuery("u")
                        ->select("u.*,p.ca_perfil")
                        ->innerJoin("u.UsuarioPerfil p")
                        ->innerJoin("u.Sucursal s")
                        ->where("u.ca_activo = ?", true);

        $global = $this->getCliente()->getProperty("cuentaglobal");
        if ($this->getCaImpoexpo() == Constantes::IMPO || $this->getCaImpoexpo() == Constantes::OTMDTA1 ) {
            if ($global) {
                $q->addWhere("p.ca_perfil = ?", "cuentas-globales");
            } else {
                $consolidar = $this->getCliente()->getProperty("consolidar_comunicaciones");
                if($consolidar)
                {
                    $q->addWhere("p.ca_perfil = ? or p.ca_perfil = ?", array("operativo-traficos","operativo-aereo"));
                }
                else
                {
                    if ($this->getCaTransporte() == Constantes::MARITIMO) {
                        $q->addWhere("p.ca_perfil = ?", "operativo-traficos");
                    } else {
                        $q->addWhere("p.ca_perfil = ?", "operativo-aereo");
                    }
                }
            }
        //    $q->addWhere("u.ca_idsucursal = ?", $usuario->getCaIdsucursal());
            $q->addWhere("s.ca_nombre = ?", $usuario->getSucursal()->getCaNombre());
            
        } 
        else if ($this->getCaImpoexpo() == Constantes::EXPO ) {
            $q->addWhere("p.ca_perfil = ?", "operativo-expo");
        }
        else if ($this->getCaImpoexpo() == Constantes::TRIANGULACION) {
            if ($global) {                
                $q->addWhere("(p.ca_perfil = ? and s.ca_nombre = ?) or p.ca_perfil=?", array("cuentas-globales",$usuario->getSucursal()->getCaNombre(),"operativo-expo"));
            } else {
                $consolidar = $this->getCliente()->getProperty("consolidar_comunicaciones");
                if($consolidar)
                {                    
                    $q->addWhere("((p.ca_perfil = ? or p.ca_perfil = ?) and s.ca_nombre = ?) or p.ca_perfil=?", array("operativo-traficos","operativo-aereo",$usuario->getSucursal()->getCaNombre(),"operativo-expo"));
                }
                else
                {
                    if ($this->getCaTransporte() == Constantes::MARITIMO) {
                        //$q->addWhere("(p.ca_perfil = ? and u.ca_idsucursal = ?) or p.ca_perfil=?", array("operativo-traficos",$usuario->getCaIdsucursal(),"operativo-expo"));
                        $q->addWhere("(p.ca_perfil = ? and s.ca_nombre = ?) or p.ca_perfil=?", array("operativo-traficos",$usuario->getSucursal()->getCaNombre(),"operativo-expo"));
                    } else {
                        //$q->addWhere("(p.ca_perfil = ? and u.ca_idsucursal = ?) or p.ca_perfil=?", array("operativo-aereo",$usuario->getCaIdsucursal(),"operativo-expo"));
                        $q->addWhere("(p.ca_perfil = ? and s.ca_nombre = ?) or p.ca_perfil=?", array("operativo-aereo",$usuario->getSucursal()->getCaNombre(),"operativo-expo"));
                        
                    }
                }
            }
            //$q->addWhere("u.ca_idsucursal = ?", $usuario->getCaIdsucursal());
        }
        //echo $q->getSqlQuery();
        return $q->execute();
    }

    /*
     * Devuelve true si corresponde a solo aduana
     */

    public function esSoloAduana() {
        $modalidadesAduana = Doctrine::getTable("Modalidad")
                        ->createQuery("m")
                        ->select("m.ca_idmodalidad")
                        ->where("m.ca_modalidad = ? OR m.ca_modalidad = ?", array("NACIONALIZACION", "ADUANA"))
                        ->setHydrationMode(Doctrine::HYDRATE_SCALAR)
                        ->execute();

        if (in_array($this->getCaModalidad(), array("NACIONALIZACION", "ADUANA"))) {
            return true;
        } else {
            return false;
        }
    }

    /*
     * Devuelve la ubicacion del directorio donde se encuentran los archivos de la referencia
     * @author Andres Botero
     */

    public function getDirectorio() {
        return sfConfig::get("app_digitalFile_root") . $this->getDirectorioBase();
    }

    public function getDirectorioDocs() {
        return sfConfig::get("app_digitalFile_root") . $this->getDirectorioBaseDocs();
    }
    /*
     * Devuelve la ubicacion del directorio donde se encuentran los archivos de la referencia
     * @author Andres Botero
     */

    public function getDirectorioBase() {
        return "reportes" . DIRECTORY_SEPARATOR . substr($this->getCaConsecutivo(), -4).DIRECTORY_SEPARATOR . $this->getCaConsecutivo() . DIRECTORY_SEPARATOR;
    }

    public function getDirectorioBaseDocs($filename) {
        
        $archivos = $this->getFilesGestDoc();
            
        if($archivos){
            foreach($archivos as $file){
                $name = $file->getCaNombre();
                if($name == $filename){
                    return str_replace( sfConfig::get('app_digitalFile_root'), "", $file->getCaPath());
                    exit;
                }                    
            }
        }else
            return null;            
    }

    /*
     * Copia el reporte y todas las tablas asociadas
     * @author Andres Botero
     * @param $opcion 1 indica que es un nuevo reporte 2 indica una nueva version
     */

    public function copiar($opcion) {
        $reporte = $this->copy();

        try {
            $conn = $this->getTable()->getConnection();
            $conn->beginTransaction();

            if ($opcion == 1) {
                $reporte->setCaConsecutivo(ReporteTable::siguienteConsecutivo(date("Y"),$this->getCaImpoexpo(), $this->getCaTransporte()          ));
                $reporte->setCaVersion(1);
                $reporte->setCaIdetapa(null);
                $reporte->setCaFchultstatus(null);
                $reporte->setCaFchreporte(date("Y-m-d"));
                $reporte->setCaFchdespacho(date("Y-m-d"));
                $reporte->setCaIdtareaAntecedente(null);
            }

            if ($opcion == 2) {
                $reporte->setCaVersion($this->numVersiones() + 1);                
            }

            $reporte->setCaDetanulado(null);
            $reporte->setCaFchcreado(null);
            $reporte->setCaUsucreado(null);
            $reporte->setCaFchactualizado(null);
            $reporte->setCaUsuactualizado(null);
            $reporte->setCaFchcerrado(null);
            $reporte->setCaUsucerrado(null);            
            $reporte->setCaPropiedades(null);
            $reporte->setProperty("subarancel",$this->getProperty("subarancel"));
            $reporte->setProperty("muelle",$this->getProperty("muelle"));
            $reporte->setProperty("entrega_lugar_arribo",$this->getProperty("entrega_lugar_arribo"));
            $reporte->save($conn);

            //Copia los conceptos
            $conceptos = $this->getRepTarifa();
            foreach ($conceptos as $concepto) {
                $newConcepto = $concepto->copy();
                $newConcepto->setCaIdconcepto($concepto->getCaIdconcepto());
                $newConcepto->setCaIdreporte($reporte->getCaIdreporte());
                $newConcepto->setCaIdreptarifa(null);
                $newConcepto->save($conn);
            }
            
            $conceptos = $this->getRepTarifa(2);
            foreach ($conceptos as $concepto) {
                $newConcepto = $concepto->copy();
                $newConcepto->setCaIdconcepto($concepto->getCaIdconcepto());
                $newConcepto->setCaIdreporte($reporte->getCaIdreporte());
                $newConcepto->setCaIdreptarifa(null);
                $newConcepto->save($conn);
            }

            //Copia los gastos
            $gastos = $this->getRecargos();
            foreach ($gastos as $gasto) {
                $newGasto = $gasto->copy();
                $newGasto->setCaIdconcepto($gasto->getCaIdconcepto());
                $newGasto->setCaIdrecargo($gasto->getCaIdrecargo());
                $newGasto->setCaIdreporte($reporte->getCaIdreporte());
                $newGasto->setCaIdequipo($gasto->getCaIdequipo());
                $newGasto->setCaIdrepgasto(null);
                if ($gasto->getCaRecargoorigen() == false)
                    $newGasto->setCaRecargoorigen("false");
                if ($gasto->getCaRecargoorigen() == true)
                    $newGasto->setCaRecargoorigen("true");
                $newGasto->save($conn);
            }

            $costos = $this->getCostos();
            foreach ($costos as $costo) {
                $newCosto = $costo->copy();
                $newCosto->setCaIdcosto($costo->getCaIdcosto());
                $newCosto->setCaIdreporte($reporte->getCaIdreporte());
                $newCosto->save($conn);
            }

            if ($this->getCaImpoexpo() == Constantes::EXPO) {
                $repExpo = $this->getRepExpo();
                $repExpoNew = $repExpo->copy();
                $repExpoNew->setCaIdreporte($reporte->getCaIdreporte());
                $repExpoNew->setCaDatosbl(null);
                $repExpoNew->save($conn);
            }

            if ($this->getCaColmas() == "Sí") {
                $repAduana = $this->getRepAduana();
                $repAduanaNew = $repAduana->copy();
                $repAduanaNew->setCaIdreporte($reporte->getCaIdreporte());
                $repAduanaNew->save();
            }            

            if ($this->getCaSeguro() == "Sí") {
                $repSeguro = $this->getRepSeguro();
                $repSeguroNew = $repSeguro->copy();
                $repSeguroNew->setCaIdreporte($reporte->getCaIdreporte());
                $repSeguroNew->save($conn);
            }
            
                if ($this->getCaTiporep() == 4 && $this->getCaImpoexpo() == Constantes::OTMDTA ) {

                    $status = $this->getUltimoStatus();
                    if(!$status)
                        $status=new RepStatus();

                    $house= $this->getInoClientesSea();
                    if(!$house)
                        $house=new InoClientesSea();
                    $master=$house->getInoMaestraSea();

                    if(!$master)
                        $master=new InoMaestraSea();

                    $repOtm = $this->getRepOtm();
                    if($repOtm)
                    {
                        $repOtmNew = $repOtm->copy();
                        $repOtmNew->setCaIdreporte($reporte->getCaIdreporte());
                    }
                    else
                    {
                        $repOtmNew = new RepOtm();
                        $repOtmNew->setCaIdreporte($reporte->getCaIdreporte());
                    }
                    $volumen = explode("|", $status->getCaVolumen());
                    if($repOtmNew->getCaVolumen()=="")
                    {
                        $repOtmNew->setCaVolumen($volumen[0] ? $volumen[0] : 0);
                    }

                    $piezas = explode("|", $status->getCaPiezas());
                    if($repOtmNew->getCaNumpiezas()=="")
                    {
                        $repOtmNew->setCaNumpiezas( $piezas[0] ? $piezas[0] : 0 );
                    }

                    if($repOtmNew->getCaNumpiezasun()=="")
                    {
                        $repOtmNew->setCaNumpiezasun( $piezas[1] ? $piezas[1] : "" );
                    }

                    $peso = explode("|", $status->getCaPeso());
                    if($repOtmNew->getCaPeso()=="")
                    {
                        $repOtmNew->setCaPeso($peso[0] ? $peso[0] : 0);
                    }

                    if($repOtmNew->getCaOrigenimpo()=="")
                    {
                        $repOtmNew->setCaOrigenimpo($this->getCaOrigen());
                    }

                    if($repOtmNew->getCaHbls()=="")
                    {
                        $repOtmNew->setCaHbls($house->getCaHbls());
                    }

                    if($repOtmNew->getCaFcharribo()=="")
                    {
                       $repOtmNew->setCaFcharribo($status->getCaFchllegada()) ;
                    }

                    if($repOtmNew->getCaFchdoctransporte()=="")
                    {
                        $repOtmNew->setCaFchdoctransporte($house->getCaFchhbls());
                    }

                    if($repOtmNew->getCaMotonave()=="")
                    {
                        $repOtmNew->setCaMotonave($status->getCaIdnave());
                    }

                    if($repOtmNew->getCaReferencia()=="")
                    {
                        $repOtmNew->setCaReferencia($house->getCaReferencia());
                    }

                    if($repOtmNew->getCaLiberacion()=="")
                    {
                        $repOtmNew->setCaLiberacion("coltrans.com.co");
                    }

                    if($repOtmNew->getCaManifiesto()=="")
                    {
                        $repOtmNew->setCaManifiesto($master->getCaFchregistroadu());
                    }

                    if($repOtmNew->getCaMuelle()=="")
                    {
                        $repOtmNew->setCaMuelle($master->getCaMuelle());
                    }

                    $repOtmNew->save($conn);
            }
            $conn->commit();
        } catch (Exception $e) {

            throw $e;
            $conn->rollBack();
        }
        return $reporte;
    }

    public function importar($reporteNew) {
        try {
            $conn = $this->getTable()->getConnection();
            $conn->beginTransaction();

            if ($reporteNew) {
                $this->setCaFchcreado(date('Y-m-d H:i:s'));

                $this->setCaOrigen($reporteNew->getCaOrigen());
                $this->setCaDestino($reporteNew->getCaDestino());
                $this->setCaIdcotizacion($reporteNew->getCaIdcotizacion());
                $this->setCaIdproducto($reporteNew->getCaIdproducto());
                $this->setCaIdcotizacionotm($reporteNew->getCaIdcotizacionotm());
                $this->setCaIdproductootm($reporteNew->getCaIdproductootm());
                //$reporte->setCaImpoexpo($reporteNew->getCaImpoexpo());
                //$reporte->setCaFchdespacho(date("Y-m-d"));
                $this->setCaIdconcliente($reporteNew->getCaIdconcliente());
                $this->setCaIdclientefac($reporteNew->getCaIdclientefac());
                $this->setCaIdclienteag($reporteNew->getCaIdclienteag());
                $this->setCaIdclienteotro($reporteNew->getCaIdclienteotro());
                $this->setCaIdagente($reporteNew->getCaIdagente());
                $this->setCaMercanciaDesc($reporteNew->getCaMercanciaDesc());
                $this->setCaIdproveedor($reporteNew->getCaIdproveedor());
                $this->setCaIncoterms($reporteNew->getCaIncoterms());

                $this->setCaConfirmarClie($reporteNew->getCaConfirmarClie());

                $this->setCaIdrepresentante($reporteNew->getCaIdrepresentante());

                $this->setCaInformarRepr($reporteNew->getCaInformarRepr());

                $this->setCaIdconsignatario($reporteNew->getCaIdconsignatario());

                $this->setCaIdnotify($reporteNew->getCaIdnotify());

                $this->setCaIdmaster($reporteNew->getCaIdmaster());


                $this->setCaInformarMast($reporteNew->getCaInformarMast());

                $this->setCaSeguro($reporteNew->getCaSeguro());

                $this->setCaLiberacion($reporteNew->getCaLiberacion());

                $this->setCaTiempocredito($reporteNew->getCaTiempocredito());
                $this->setCaComodato($reporteNew->getCaComodato());
                $this->setCaPreferenciasClie($reporteNew->getCaPreferenciasClie());
                $this->setCaInstrucciones($reporteNew->getCaInstrucciones());

                $this->setCaIdlinea($reporteNew->getCaIdlinea());
                $this->setCaIdconsignar($reporteNew->getCaIdconsignar());

                $this->setCaIdconsignarmaster($reporteNew->getCaIdconsignarmaster());
                $this->setCaIdbodega($reporteNew->getCaIdbodega());
                $this->setCaContinuacion($reporteNew->getCaContinuacion());

                $this->setCaContinuacionDest($reporteNew->getCaContinuacionDest());
                $this->setCaContOrigen($reporteNew->getCaContOrigen());
                $this->setCaContDestino($reporteNew->getCaContDestino());


                $this->setCaContinuacionConf($reporteNew->getCaContinuacionConf());

                $this->setCaColmas($reporteNew->getCaColmas());
                $this->setCaMciaPeligrosa($reporteNew->getCaMciaPeligrosa());

                $this->save($conn);

                $conceptos = $this->getRepTarifa();
                foreach ($conceptos as $concepto) {
                    $concepto->delete();
                }

                $conceptos = $reporteNew->getRepTarifa();
                foreach ($conceptos as $concepto) {
                    $newConcepto = $concepto->copy();
                    $newConcepto->setCaIdconcepto($concepto->getCaIdconcepto());
                    $newConcepto->setCaIdreporte($this->getCaIdreporte());
                    $newConcepto->setCaIdreptarifa(null);
                    $newConcepto->save($conn);
                }
                
                $conceptos = $this->getRepTarifa(2);
                foreach ($conceptos as $concepto) {
                    $concepto->delete();
                }
                
                $conceptos = $reporteNew->getRepTarifa(2);
                foreach ($conceptos as $concepto) {
                    $newConcepto = $concepto->copy();
                    $newConcepto->setCaIdconcepto($concepto->getCaIdconcepto());
                    $newConcepto->setCaIdreporte($this->getCaIdreporte());
                    $newConcepto->setCaIdreptarifa(null);
                    $newConcepto->save($conn);
                }

                $gastos = $this->getRecargos();
                foreach ($gastos as $gasto) {
                    $gasto->delete();
                }
                //Copia los gastos
                $gastos = $reporteNew->getRecargos();
                foreach ($gastos as $gasto) {
                    $newGasto = $gasto->copy();
                    $newGasto->setCaIdconcepto($gasto->getCaIdconcepto());
                    $newGasto->setCaIdrecargo($gasto->getCaIdrecargo());
                    $newGasto->setCaIdreporte($this->getCaIdreporte());
                    $newGasto->setCaIdrepgasto(null);
                    if ($gasto->getCaRecargoorigen() == false)
                        $newGasto->setCaRecargoorigen("false");
                    if ($gasto->getCaRecargoorigen() == true)
                        $newGasto->setCaRecargoorigen("true");
                    $newGasto->save($conn);
                }

                $costos = $this->getCostos();
                foreach ($costos as $costo) {
                    $costo->delete();
                }

                $costos = $reporteNew->getCostos();
                foreach ($costos as $costo) {
                    $newCosto = $costo->copy();
                    $newCosto->setCaIdcosto($costo->getCaIdcosto());
                    $newCosto->setCaIdreporte($this->getCaIdreporte());
                    $newCosto->save($conn);
                }

                if ($reporteNew->getCaImpoexpo() == Constantes::EXPO) {
                    $repExpo = $this->getRepExpo();
                    $repExpo->delete();
                    $repExpo = $reporteNew->getRepExpo();
                    $repExpoNew = $repExpo->copy();
                    $repExpoNew->setCaIdreporte($this->getCaIdreporte());
                    $repExpoNew->save($conn);
                }

                if ($reporteNew->getCaColmas() == "Sí") {
                    $repAduana = $this->getRepAduana();
                    $repAduana->delete();
                    $repAduana = $reporteNew->getRepAduana();
                    $repAduanaNew = $repAduana->copy();
                    $repAduanaNew->setCaIdreporte($this->getCaIdreporte());
                    $repAduanaNew->save($conn);
                }

                if ($reporteNew->getCaSeguro() == "Sí") {
                    $repSeguro = $this->getRepSeguro();
                    $repSeguro->delete();

                    $repSeguro = $reporteNew->getRepSeguro();
                    if ($repSeguro) {
                        $repSeguroNew = $repSeguro->copy();
                        $repSeguroNew->setCaIdreporte($this->getCaIdreporte());
                        $repSeguroNew->save($conn);
                    }
                }                
                $conn->commit();
                return true;
            } else {
                $conn->rollBack();
                return false;
            }
            //Copia los conceptos
        } catch (Exception $e) {
            throw $e;
            $conn->rollBack();
            return false;
        }
    }

    public function getTareas($idlista=null) {
        $q = Doctrine::getTable("NotTarea")
                        ->createQuery("t")
                        ->innerJoin("t.RepAsignacion a")
                        ->innerJoin("a.Reporte r")
                        ->where("r.ca_consecutivo = ?", $this->getCaConsecutivo())
                        ->addOrderBy("t.ca_fchvencimiento ASC");

        if ($idlista) {
            $q->addWhere("t.ca_idlistatarea = ?", $idlista);
        }

        return $q->execute();
    }

    public function getTerceroBodega() {

        if($this->getCaIdconsignatario()>0)
        {
            $con = Doctrine_Manager::getInstance()->connection();
            //echo $this->getCaConsecutivo();
            $sql="select b.ca_idbodega from tb_terceros t
            inner join tb_bodegas b on t.ca_identificacion = fun_getnit_bodega_tercero(b.ca_nombre)
            where ca_idtercero=".$this->getCaIdconsignatario();
            $st = $con->execute($sql);
            $bodega = $st->fetchColumn(0);
        }
        else
        {
            $bodega=0;
        }

        return $bodega;
    }
    
     public function getEmails($tipo="Orden OTM") {
        $emails = Doctrine::getTable("Email")
                        ->createQuery("e")
                        ->addWhere("ca_tipo=? and ca_subject like ?", array($tipo,"%" . $this->getCaIdreporte()."%" ) )
                        ->addOrderBy("e.ca_idemail DESC")
                        ->execute();
        return $emails;
    }
    
    
    /*
     * Compara un dato de la version anterior
     */
    public function compDato($dato,$dato1)
    {
        if(!$this->repAnterior){
            $this->repAnterior=ReporteTable::retrieveByConsecutivo($this->getCaConsecutivo()," and ca_version<='".($this->getCaVersion()-1)."'");
        }       
        if($dato=="Property")
        {
            //echo $dato1;
            eval( " \$str1 = \$this->get".$dato."(".$dato1.");" );
            eval( " \$str2 = \$this->repAnterior->get".$dato."(".$dato1.");" );
            //echo "MAQR".$str1;            
        }
        else
        {
            eval( " \$str1 = \$this->get".$dato."();" );
            eval( " \$str2 = \$this->repAnterior->get".$dato."();" );
        }
        return strcmp($str1, $str2);
    }
    
    
    public function getTareaIDGEnvioOportuno() {

        $tarea = null;
        if ($this->getProperty("IdgEnvioOportuno")>0) {
            $tarea = Doctrine::getTable("NotTarea")->find($this->getProperty("IdgEnvioOportuno"));
        }
        return $tarea;
    }
    
    public function crearTareaIDGEnvioOportuno($fchCreado) {

        $tarea = $this->getTareaIDGEnvioOportuno();        
        if (!$tarea) {

            $titulo = "Reporte Negocio " . $this->getCaConsecutivo() . " " . $this->getCliente()->getCaCompania();
            $texto = "Debe entregar este Reporte de negocios por email ";

            $tarea = new NotTarea();
            $tarea->setCaIdlistatarea(11);
            $tarea->setCaUrl("/reportesNeg/verReporte/id/" . $this->getCaIdreporte()  );
            $tarea->setCaUsucreado($this->getCaUsucreado());
            $tarea->setCaTitulo($titulo);
            $tarea->setCaTexto($texto);
            $tarea->setCaFchcreado($fchCreado);
            $tarea->setCaFchvisible(date("Y-m-d H:i:s", time() ));
            $tarea->setTiempo(TimeUtils::getFestivos(), $this->getTiempoIdg($fchCreado));
            $tarea->save();

            $this->setProperty("IdgEnvioOportuno", $tarea->getCaIdtarea());
            $this->save();
        }


        $tarea->setCaFchcreado($fchCreado);
        $tarea->setTiempo(TimeUtils::getFestivos(), $this->getTiempoIdg($fchCreado));
        $tarea->save();

        if ($tarea) {
            $loginsAsignaciones = array($this->getCaUsucreado());
            if ($this->getCaUsuactualizado()) {
                $loginsAsignaciones[] = $this->getCaUsuactualizado();
            }
            $tarea->setAsignaciones($loginsAsignaciones);
        }
        return $tarea;
    }
    
    public function getTiempoIdg($fchTarea) {        
        $tiempoIdg = 1 * 3600;
        return $tiempoIdg;
    }
    
    public function postInsert($event) {
        parent::postInsert($event);
        if($this->getUsucreado()->getSucursal()->getCaNombre()==Constantes::BOGOTA && ( $this->getUsucreado()->getCaDepartamento()=='Comercial' || $this->getUsucreado()->getCaDepartamento()=="Servicio al Cliente"))
        {
            $this->crearTareaIDGEnvioOportuno(date("Y-m-d H:i:s"));
        }
        
    } 
    /*public function save(Doctrine_Connection $con = null) {
        if($this->preInsert($event))
        parent::save($con);        
    }*/
}